version: '3.8'

# Lago Billing - Optimized Staging Deployment
# Connects to shared Infrastructure (Postgres/Redis) to save resources.

services:
  # ============================
  # LAGO API
  # ============================
  lago-api:
    image: getlago/api:v1.16.0
    container_name: lago-api
    restart: unless-stopped
    depends_on:
      - lago-worker
    environment:
      - DATABASE_URL=postgresql://admin:QWyfkmjcfbpYnMDkxqzAOJBcPvlZCtkh8R%2F%2BDTz%2BSkA%3D@bizosaas-postgres-staging:5432/lago
      - REDIS_URL=redis://bizosaas-redis-staging:6379/5
      - LAGO_REDIS_CACHE_URL=redis://bizosaas-redis-staging:6379/5
      - LAGO_SIDEKIQ_REDIS_URL=redis://bizosaas-redis-staging:6379/5
      - LAGO_API_URL=http://lago-api:3000
      - LAGO_FRONT_URL=http://lago-front:80
      - LAGO_DISABLE_SEGMENT=true
      # Values to be set in Dokploy UI
      - LAGO_SECRET_KEY_BASE=${LAGO_SECRET_KEY_BASE}
      - |
        LAGO_RSA_PRIVATE_KEY=-----BEGIN PRIVATE KEY-----
        MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDN1mAYiHBgPRSo
        diTRThTH/I8EjWVDZMFoFDFsZlRiGM0+xHm6xIgiBNs/IFV3ma1eRKeNZZpQtaNq
        yncFbzjSLg6lDs4CVjAAOI3MXj8Evy5XXu3aVaeLTTtcKiEvfgOkcYLrIu80uM5E
        RcQ+/SaUOdBKKuD74sQYWBx2MUSFOcgNC2XbyLDdwtGWMWCANCuVFsCwi4qDgCgV
        DJbc+yY2/ga3JhGLTWTq3kBa8VArld994NH7GCQUwPa3eIqPpS864eOWxk2dPkvG
        tvq+bHi3bSKF7OAU/CcHLa5H7TG3pU/MQ0P65//b9pDlZXDBcPihU8o1lbMmfyUc
        yvRagz5HAgMBAAECggEAXWO65NaemeOMqGQ2DyrMffIGV4vpmlqv749d3y9McNeM
        48IT8tuxYjHu4aTDckis4pzmol4rVhwbQVwMBVCxqJbR+SyO5nuBOtBt8X//OqGd
        HnIJG6sKIcdQO+A3f0s+ztDbk+CdRD/nAg3fXK7R3qWebdAnlNENpHfxreRrkL/W
        mzemJw2in3IUTTabO4wdrtzwEvxNu8giXFAqqT72YMf3s9Jik78wZQlPS6OQuwyf
        eS5549J0eNIe9dcx4UZuD5YkDSGyJjsBC6sz3sdiZMnQSXSrCy4GYQAqxr265LRl
        KmCcbXQqy95UF1HRnd0E9FV5kf5ihGgfo8PZv+P+eQKBgQDvTy5iiQyDVABqM0OC
        XqC1wH3IPiGqYuVpZ1zjD6wE+bijtoUOKJHiyFRDh1iOSMqpmGHJYRWyEp5qpy+n
        d4faCZenqnrUW3in82xzh/bmrWhOfFrInlbqxIq08d4WWx4li7XPF7TjVYalQEg/
        42Ds3qd0V4/PlBxsO0+RyQcoLwKBgQDcMY9t6WUgHGHYixJnFxdGQ1Pz5/OvsrJG
        AON52QM/qukQBpCBXQsnY3hmWGmsSJtltykBr4JF1JpIHhfS5C3i0bJX9j/maL3i
        es34MQDAJ5LWZOI6qRemtVHGbuFWZKpysLyUBfbP/HOC0YKEWAYp7Nj6BWdDOtI7
        fhou71StaQKBgD3eG6DPy5NcMStDi411x1iVpi8RmQSCwsqINWRiVdeHc+unMSji
        5ixaHCbFI+jM+s/znDxCxCggViI+jLxf05hT6IgpM84Yw82vyfboTLWAWToJPjMl
        dFUHcNCswvzGm7mbL+qVN2eaYc/xGXyi3Rj/ywzx4jUJFnwIrV6EOTxzAoGBANny
        JCmCbpnN/fs8DEcFz/+3/Iza9ZTepx4rGv0sE88c9/roxHeHBNdD2ZRTxqTEaSvQ
        k0Ib2jIMMXlYb/RJ7jEnpgLytmT1H53gN6aFulx3zxtuV44AeGyF5B8o+NluYleL
        H9zT2mwbUKoXfbxI9DDjQhCW8JLW0egY9Qmn0oShAoGAVQ018BuQk9446b9AXXNX
        0+QzAv6yXgVJ6ZEi1bIv0rzkGZNRNCwBK4lm35XsWK/DRWU/w1QyGxc6MOobztrg
        voYJF8YksAMdIZdmAIbDln9xsgxW86J4/F2fX77YyAcsTXh1H6UEbN9ftgfR2htB
        iYWiHjLsKJnSQuDh9tQl6BM=
        -----END PRIVATE KEY-----
      - |
        LAGO_RSA_PUBLIC_KEY=-----BEGIN PUBLIC KEY-----
        MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAzdZgGIhwYD0UqHYk0U4U
        x/yPBI1lQ2TBaBQxbGZUYhjNPsR5usSIIgTbPyBVd5mtXkSnjWWaULWjasp3BW84
        0i4OpQ7OAlYwADiNzF4/BL8uV17t2lWni007XCohL34DpHGC6yLvNLjOREXEPv0m
        lDnQSirg++LEGFgcdjFEhTnIDQtl28iw3cLRljFggDQrlRbAsIuKg4AoFQyW3Psm
        Nv4GtyYRi01k6t5AWvFQK5XffeDR+xgkFMD2t3iKj6UvOuHjlsZNnT5Lxrb6vmx4
        t20ihezgFPwnBy2uR+0xt6VPzEND+uf/2/aQ5WVwwXD4oVPKNZWzJn8lHMr0WoM+
        RwIDAQAB
        -----END PUBLIC KEY-----
      - LAGO_ENCRYPTION_PRIMARY_KEY=${LAGO_ENCRYPTION_PRIMARY_KEY}
      - LAGO_ENCRYPTION_DETERMINISTIC_KEY=${LAGO_ENCRYPTION_DETERMINISTIC_KEY}
      - LAGO_ENCRYPTION_KEY_DERIVATION_SALT=${LAGO_ENCRYPTION_KEY_DERIVATION_SALT}
      - RAILS_ENV=production
      - LAGO_DISABLE_SIGNUP=false
    networks:
      - dokploy-network
    ports:
      - "3000"

  # ============================
  # LAGO WORKER
  # ============================
  lago-worker:
    image: getlago/api:v1.16.0
    container_name: lago-worker
    restart: unless-stopped
    command: ./scripts/start.worker.sh
    environment:
      - DATABASE_URL=postgresql://admin:BizOSaaS2025!StagingDB@bizosaas-postgres-staging:5432/lago
      - REDIS_URL=redis://bizosaas-redis-staging:6379/5
      - LAGO_REDIS_CACHE_URL=redis://bizosaas-redis-staging:6379/5
      - LAGO_SIDEKIQ_REDIS_URL=redis://bizosaas-redis-staging:6379/5
      - LAGO_API_URL=http://lago-api:3000
      - LAGO_FRONT_URL=http://lago-front:80
      - LAGO_DISABLE_SEGMENT=true
      # Values to be set in Dokploy UI
      - LAGO_SECRET_KEY_BASE=${LAGO_SECRET_KEY_BASE}
      - |
        LAGO_RSA_PRIVATE_KEY=-----BEGIN PRIVATE KEY-----
        MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDN1mAYiHBgPRSo
        diTRThTH/I8EjWVDZMFoFDFsZlRiGM0+xHm6xIgiBNs/IFV3ma1eRKeNZZpQtaNq
        yncFbzjSLg6lDs4CVjAAOI3MXj8Evy5XXu3aVaeLTTtcKiEvfgOkcYLrIu80uM5E
        RcQ+/SaUOdBKKuD74sQYWBx2MUSFOcgNC2XbyLDdwtGWMWCANCuVFsCwi4qDgCgV
        DJbc+yY2/ga3JhGLTWTq3kBa8VArld994NH7GCQUwPa3eIqPpS864eOWxk2dPkvG
        tvq+bHi3bSKF7OAU/CcHLa5H7TG3pU/MQ0P65//b9pDlZXDBcPihU8o1lbMmfyUc
        yvRagz5HAgMBAAECggEAXWO65NaemeOMqGQ2DyrMffIGV4vpmlqv749d3y9McNeM
        48IT8tuxYjHu4aTDckis4pzmol4rVhwbQVwMBVCxqJbR+SyO5nuBOtBt8X//OqGd
        HnIJG6sKIcdQO+A3f0s+ztDbk+CdRD/nAg3fXK7R3qWebdAnlNENpHfxreRrkL/W
        mzemJw2in3IUTTabO4wdrtzwEvxNu8giXFAqqT72YMf3s9Jik78wZQlPS6OQuwyf
        eS5549J0eNIe9dcx4UZuD5YkDSGyJjsBC6sz3sdiZMnQSXSrCy4GYQAqxr265LRl
        KmCcbXQqy95UF1HRnd0E9FV5kf5ihGgfo8PZv+P+eQKBgQDvTy5iiQyDVABqM0OC
        XqC1wH3IPiGqYuVpZ1zjD6wE+bijtoUOKJHiyFRDh1iOSMqpmGHJYRWyEp5qpy+n
        d4faCZenqnrUW3in82xzh/bmrWhOfFrInlbqxIq08d4WWx4li7XPF7TjVYalQEg/
        42Ds3qd0V4/PlBxsO0+RyQcoLwKBgQDcMY9t6WUgHGHYixJnFxdGQ1Pz5/OvsrJG
        AON52QM/qukQBpCBXQsnY3hmWGmsSJtltykBr4JF1JpIHhfS5C3i0bJX9j/maL3i
        es34MQDAJ5LWZOI6qRemtVHGbuFWZKpysLyUBfbP/HOC0YKEWAYp7Nj6BWdDOtI7
        fhou71StaQKBgD3eG6DPy5NcMStDi411x1iVpi8RmQSCwsqINWRiVdeHc+unMSji
        5ixaHCbFI+jM+s/znDxCxCggViI+jLxf05hT6IgpM84Yw82vyfboTLWAWToJPjMl
        dFUHcNCswvzGm7mbL+qVN2eaYc/xGXyi3Rj/ywzx4jUJFnwIrV6EOTxzAoGBANny
        JCmCbpnN/fs8DEcFz/+3/Iza9ZTepx4rGv0sE88c9/roxHeHBNdD2ZRTxqTEaSvQ
        k0Ib2jIMMXlYb/RJ7jEnpgLytmT1H53gN6aFulx3zxtuV44AeGyF5B8o+NluYleL
        H9zT2mwbUKoXfbxI9DDjQhCW8JLW0egY9Qmn0oShAoGAVQ018BuQk9446b9AXXNX
        0+QzAv6yXgVJ6ZEi1bIv0rzkGZNRNCwBK4lm35XsWK/DRWU/w1QyGxc6MOobztrg
        voYJF8YksAMdIZdmAIbDln9xsgxW86J4/F2fX77YyAcsTXh1H6UEbN9ftgfR2htB
        iYWiHjLsKJnSQuDh9tQl6BM=
        -----END PRIVATE KEY-----
      - |
        LAGO_RSA_PUBLIC_KEY=-----BEGIN PUBLIC KEY-----
        MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAzdZgGIhwYD0UqHYk0U4U
        x/yPBI1lQ2TBaBQxbGZUYhjNPsR5usSIIgTbPyBVd5mtXkSnjWWaULWjasp3BW84
        0i4OpQ7OAlYwADiNzF4/BL8uV17t2lWni007XCohL34DpHGC6yLvNLjOREXEPv0m
        lDnQSirg++LEGFgcdjFEhTnIDQtl28iw3cLRljFggDQrlRbAsIuKg4AoFQyW3Psm
        Nv4GtyYRi01k6t5AWvFQK5XffeDR+xgkFMD2t3iKj6UvOuHjlsZNnT5Lxrb6vmx4
        t20ihezgFPwnBy2uR+0xt6VPzEND+uf/2/aQ5WVwwXD4oVPKNZWzJn8lHMr0WoM+
        RwIDAQAB
        -----END PUBLIC KEY-----
      - LAGO_ENCRYPTION_PRIMARY_KEY=${LAGO_ENCRYPTION_PRIMARY_KEY}
      - LAGO_ENCRYPTION_DETERMINISTIC_KEY=${LAGO_ENCRYPTION_DETERMINISTIC_KEY}
      - LAGO_ENCRYPTION_KEY_DERIVATION_SALT=${LAGO_ENCRYPTION_KEY_DERIVATION_SALT}
      - RAILS_ENV=production
    networks:
      - dokploy-network

  # ============================
  # LAGO FRONTEND
  # ============================
  lago-front:
    image: getlago/front:v1.16.0
    container_name: lago-front
    restart: unless-stopped
    depends_on:
      - lago-api
    environment:
      - API_URL=http://lago-api:3000
      - API_BASE_URL=/
    networks:
      - dokploy-network
    ports:
      - "8088:80"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.lago-front.rule=Host(`billing.bizoholic.net`)"
      - "traefik.http.routers.lago-front.entrypoints=websecure"
      - "traefik.http.routers.lago-front.tls.certresolver=myresolver"
      - "traefik.http.services.lago-front.loadbalancer.server.port=80"

  # ============================
  # MIGRATION UTILITY
  # ============================
  lago-migrate:
    image: getlago/api:v1.16.0
    command: [ "./scripts/migrate.sh" ]
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${LAGO_POSTGRES_DB:-lago}
      - REDIS_URL=redis://redis:6379/5
      - SECRET_KEY_BASE=${LAGO_SECRET_KEY_BASE}
      - |
        LAGO_RSA_PRIVATE_KEY=-----BEGIN PRIVATE KEY-----
        MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDN1mAYiHBgPRSo
        diTRThTH/I8EjWVDZMFoFDFsZlRiGM0+xHm6xIgiBNs/IFV3ma1eRKeNZZpQtaNq
        yncFbzjSLg6lDs4CVjAAOI3MXj8Evy5XXu3aVaeLTTtcKiEvfgOkcYLrIu80uM5E
        RcQ+/SaUOdBKKuD74sQYWBx2MUSFOcgNC2XbyLDdwtGWMWCANCuVFsCwi4qDgCgV
        DJbc+yY2/ga3JhGLTWTq3kBa8VArld994NH7GCQUwPa3eIqPpS864eOWxk2dPkvG
        tvq+bHi3bSKF7OAU/CcHLa5H7TG3pU/MQ0P65//b9pDlZXDBcPihU8o1lbMmfyUc
        yvRagz5HAgMBAAECggEAXWO65NaemeOMqGQ2DyrMffIGV4vpmlqv749d3y9McNeM
        48IT8tuxYjHu4aTDckis4pzmol4rVhwbQVwMBVCxqJbR+SyO5nuBOtBt8X//OqGd
        HnIJG6sKIcdQO+A3f0s+ztDbk+CdRD/nAg3fXK7R3qWebdAnlNENpHfxreRrkL/W
        mzemJw2in3IUTTabO4wdrtzwEvxNu8giXFAqqT72YMf3s9Jik78wZQlPS6OQuwyf
        eS5549J0eNIe9dcx4UZuD5YkDSGyJjsBC6sz3sdiZMnQSXSrCy4GYQAqxr265LRl
        KmCcbXQqy95UF1HRnd0E9FV5kf5ihGgfo8PZv+P+eQKBgQDvTy5iiQyDVABqM0OC
        XqC1wH3IPiGqYuVpZ1zjD6wE+bijtoUOKJHiyFRDh1iOSMqpmGHJYRWyEp5qpy+n
        d4faCZenqnrUW3in82xzh/bmrWhOfFrInlbqxIq08d4WWx4li7XPF7TjVYalQEg/
        42Ds3qd0V4/PlBxsO0+RyQcoLwKBgQDcMY9t6WUgHGHYixJnFxdGQ1Pz5/OvsrJG
        AON52QM/qukQBpCBXQsnY3hmWGmsSJtltykBr4JF1JpIHhfS5C3i0bJX9j/maL3i
        es34MQDAJ5LWZOI6qRemtVHGbuFWZKpysLyUBfbP/HOC0YKEWAYp7Nj6BWdDOtI7
        fhou71StaQKBgD3eG6DPy5NcMStDi411x1iVpi8RmQSCwsqINWRiVdeHc+unMSji
        5ixaHCbFI+jM+s/znDxCxCggViI+jLxf05hT6IgpM84Yw82vyfboTLWAWToJPjMl
        dFUHcNCswvzGm7mbL+qVN2eaYc/xGXyi3Rj/ywzx4jUJFnwIrV6EOTxzAoGBANny
        JCmCbpnN/fs8DEcFz/+3/Iza9ZTepx4rGv0sE88c9/roxHeHBNdD2ZRTxqTEaSvQ
        k0Ib2jIMMXlYb/RJ7jEnpgLytmT1H53gN6aFulx3zxtuV44AeGyF5B8o+NluYleL
        H9zT2mwbUKoXfbxI9DDjQhCW8JLW0egY9Qmn0oShAoGAVQ018BuQk9446b9AXXNX
        0+QzAv6yXgVJ6ZEi1bIv0rzkGZNRNCwBK4lm35XsWK/DRWU/w1QyGxc6MOobztrg
        voYJF8YksAMdIZdmAIbDln9xsgxW86J4/F2fX77YyAcsTXh1H6UEbN9ftgfR2htB
        iYWiHjLsKJnSQuDh9tQl6BM=
        -----END PRIVATE KEY-----
      - |
        LAGO_RSA_PUBLIC_KEY=-----BEGIN PUBLIC KEY-----
        MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAzdZgGIhwYD0UqHYk0U4U
        x/yPBI1lQ2TBaBQxbGZUYhjNPsR5usSIIgTbPyBVd5mtXkSnjWWaULWjasp3BW84
        0i4OpQ7OAlYwADiNzF4/BL8uV17t2lWni007XCohL34DpHGC6yLvNLjOREXEPv0m
        lDnQSirg++LEGFgcdjFEhTnIDQtl28iw3cLRljFggDQrlRbAsIuKg4AoFQyW3Psm
        Nv4GtyYRi01k6t5AWvFQK5XffeDR+xgkFMD2t3iKj6UvOuHjlsZNnT5Lxrb6vmx4
        t20ihezgFPwnBy2uR+0xt6VPzEND+uf/2/aQ5WVwwXD4oVPKNZWzJn8lHMr0WoM+
        RwIDAQAB
        -----END PUBLIC KEY-----
      - LAGO_ENCRYPTION_PRIMARY_KEY=${LAGO_ENCRYPTION_PRIMARY_KEY}
      - LAGO_ENCRYPTION_DETERMINISTIC_KEY=${LAGO_ENCRYPTION_DETERMINISTIC_KEY}
      - LAGO_ENCRYPTION_KEY_DERIVATION_SALT=${LAGO_ENCRYPTION_KEY_DERIVATION_SALT}
      - RAILS_ENV=production
    networks:
      - dokploy-network

networks:
  dokploy-network:
    external: true
