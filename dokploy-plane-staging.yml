version: "3.8"

services:
  plane-web:
    image: makeplane/plane-frontend:stable
    restart: unless-stopped
    volumes:
      - /var/www/plane/logs:/app/logs
    environment:
      - NEXT_PUBLIC_API_BASE_URL=https://plane-api.bizoholic.net
      - NEXT_PUBLIC_DEPLOY_URL=https://plane.bizoholic.net
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.plane-web.rule=Host(`plane.bizoholic.net`)"
      - "traefik.http.routers.plane-web.entrypoints=websecure"
      - "traefik.http.routers.plane-web.tls.certresolver=myresolver"
      - "traefik.http.services.plane-web.loadbalancer.server.port=3000"

  plane-api:
    image: makeplane/plane-backend:stable
    restart: unless-stopped
    depends_on:
      - plane-worker
      - plane-beat
    volumes:
      - /var/www/plane/logs:/app/logs
      - plane_media:/app/media
    environment:
      - DATABASE_URL=postgresql://admin:QWyfkmjcfbpYnMDkxqzAOJBcPvlZCtkh8R%2F%2BDTz%2BSkA%3D@bizosaas-postgres-staging:5432/plane_db
      - REDIS_URL=redis://bizosaas-redis-staging:6379/4
      - CELERY_BROKER_URL=redis://bizosaas-redis-staging:6379/4
      - EMAIL_HOST=${EMAIL_HOST}
      - EMAIL_HOST_USER=${EMAIL_HOST_USER}
      - EMAIL_HOST_PASSWORD=${EMAIL_HOST_PASSWORD}
      - EMAIL_PORT=587
      - EMAIL_USE_TLS=1
      - WEB_URL=https://plane.bizoholic.net
      - CORS_ALLOWED_ORIGINS=https://plane.bizoholic.net
      - SECRET_KEY=${PLANE_SECRET_KEY}
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.plane-api.rule=Host(`plane-api.bizoholic.net`)"
      - "traefik.http.routers.plane-api.entrypoints=websecure"
      - "traefik.http.routers.plane-api.tls.certresolver=myresolver"
      - "traefik.http.services.plane-api.loadbalancer.server.port=8000"

  plane-worker:
    image: makeplane/plane-backend:stable
    restart: unless-stopped
    command: ./bin/docker-entrypoint-worker.sh
    environment:
      - DATABASE_URL=postgresql://admin:QWyfkmjcfbpYnMDkxqzAOJBcPvlZCtkh8R%2F%2BDTz%2BSkA%3D@bizosaas-postgres-staging:5432/plane_db
      - REDIS_URL=redis://bizosaas-redis-staging:6379/4
      - CELERY_BROKER_URL=redis://bizosaas-redis-staging:6379/4
      - SECRET_KEY=${PLANE_SECRET_KEY}
    networks:
      - dokploy-network

  plane-beat:
    image: makeplane/plane-backend:stable
    restart: unless-stopped
    command: ./bin/docker-entrypoint-beat.sh
    environment:
      - DATABASE_URL=postgresql://admin:QWyfkmjcfbpYnMDkxqzAOJBcPvlZCtkh8R%2F%2BDTz%2BSkA%3D@bizosaas-postgres-staging:5432/plane_db
      - REDIS_URL=redis://bizosaas-redis-staging:6379/4
      - SECRET_KEY=${PLANE_SECRET_KEY}
    networks:
      - dokploy-network

volumes:
  plane_media:

networks:
  dokploy-network:
    external: true
