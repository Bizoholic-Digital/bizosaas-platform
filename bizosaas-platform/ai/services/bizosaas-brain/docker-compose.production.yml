version: '3.8'

services:
  brain-gateway:
    image: ghcr.io/bizoholic-digital/bizosaas-brain:latest
    container_name: bizosaas-brain-gateway
    restart: unless-stopped

    environment:
      - PYTHONPATH=/app
      - VAULT_ADDR=http://bizosaas-vault:8200
      - VAULT_TOKEN=bizosaas-dev-root-token
      - VAULT_MOUNT_PATH=bizosaas
      - BRAIN_API_URL=http://localhost:8001

    networks:
      - dokploy-network

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    deploy:
      mode: replicated
      replicas: 1
      labels:
        # Enable Traefik
        - "traefik.enable=true"

        # HTTP Router Configuration for api.bizoholic.com
        - "traefik.http.routers.brain-gateway.rule=Host(`api.bizoholic.com`)"
        - "traefik.http.routers.brain-gateway.entrypoints=websecure"
        - "traefik.http.routers.brain-gateway.tls=true"
        - "traefik.http.routers.brain-gateway.tls.certresolver=letsencrypt"

        # Service Configuration
        - "traefik.http.services.brain-gateway.loadbalancer.server.port=8001"

        # Network Configuration
        - "traefik.docker.network=dokploy-network"

      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

networks:
  dokploy-network:
    external: true
