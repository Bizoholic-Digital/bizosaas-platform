version: '3.8'

# Plane Project Management - Local Development Setup
# This compose file runs Plane locally and connects to existing infrastructure

services:
  # Plane Web (Frontend)
  plane-web:
    image: makeplane/plane-frontend:stable
    container_name: plane-web-local
    ports:
      - "3002:3000"
    environment:
      - NEXT_PUBLIC_API_BASE_URL=http://localhost:8090
      - NEXT_PUBLIC_DEPLOY_URL=http://localhost:3002
    networks:
      - bizosaas-local
    depends_on:
      - plane-api
    restart: unless-stopped

  # Plane API (Backend)
  plane-api:
    image: makeplane/plane-backend:stable
    container_name: plane-api-local
    ports:
      - "8090:8000"
    environment:
      # Connect to existing PostgreSQL on host
      - DATABASE_URL=postgresql://admin:BizOSaaS2025!StagingDB@host.docker.internal:5433/plane_db
      # Connect to existing Redis on host (DB 4 for Plane)
      - REDIS_URL=redis://host.docker.internal:6380/4
      # Security
      - SECRET_KEY=local-dev-secret-key-plane-2025-change-in-production
      - DJANGO_SETTINGS_MODULE=plane.settings.production
      # URLs
      - WEB_URL=http://localhost:3002
      - CORS_ALLOWED_ORIGINS=http://localhost:3000,http://localhost:3001,http://localhost:8001
      # Email (optional for local)
      - EMAIL_BACKEND=django.core.mail.backends.console.EmailBackend
    networks:
      - bizosaas-local
    volumes:
      - plane_media_local:/plane/media
    restart: unless-stopped

  # Plane Worker (Background Jobs)
  plane-worker:
    image: makeplane/plane-backend:stable
    container_name: plane-worker-local
    command: celery -A plane worker -l info -c 2
    environment:
      - DATABASE_URL=postgresql://admin:BizOSaaS2025!StagingDB@host.docker.internal:5433/plane_db
      - REDIS_URL=redis://host.docker.internal:6380/4
      - SECRET_KEY=local-dev-secret-key-plane-2025-change-in-production
    networks:
      - bizosaas-local
    volumes:
      - plane_media_local:/plane/media
    depends_on:
      - plane-api
    restart: unless-stopped

  # Plane Beat (Scheduler)
  plane-beat:
    image: makeplane/plane-backend:stable
    container_name: plane-beat-local
    command: celery -A plane beat -l info
    environment:
      - DATABASE_URL=postgresql://admin:BizOSaaS2025!StagingDB@host.docker.internal:5433/plane_db
      - REDIS_URL=redis://host.docker.internal:6380/4
      - SECRET_KEY=local-dev-secret-key-plane-2025-change-in-production
    networks:
      - bizosaas-local
    depends_on:
      - plane-api
    restart: unless-stopped

volumes:
  plane_media_local:
    driver: local

networks:
  bizosaas-local:
    driver: bridge

# ==================================================
# PLANE LOCAL TESTING SETUP
# ==================================================
#
# Prerequisites:
# 1. PostgreSQL running on host:5433 (bizosaas-postgres-staging)
# 2. Redis running on host:6380 (bizosaas-redis-staging)
#
# Setup Instructions:
#
# 1. Create Plane database:
#    docker exec bizosaas-postgres-staging psql -U admin -d bizosaas_staging -c "CREATE DATABASE plane_db;"
#
# 2. Start Plane:
#    docker-compose -f docker-compose.plane-local.yml up -d
#
# 3. Initialize database:
#    docker exec plane-api-local python manage.py migrate
#
# 4. Create admin user:
#    docker exec -it plane-api-local python manage.py createsuperuser
#
# 5. Access Plane:
#    Web UI: http://localhost:3002
#    API: http://localhost:8090
#
# 6. Generate API Key:
#    - Login to http://localhost:3002
#    - Go to Settings â†’ API Tokens
#    - Create new token
#    - Use in connector: http://localhost:8090
#
# ==================================================
