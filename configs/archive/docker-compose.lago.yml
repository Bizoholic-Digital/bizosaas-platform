services:
  lago-db:
    image: postgres:14-alpine
    container_name: lago-db
    restart: always
    environment:
      - POSTGRES_DB=lago
      - POSTGRES_USER=lago
      - POSTGRES_PASSWORD=lago_password_2025
    volumes:
      - lago_db_vol:/var/lib/postgresql/data
    networks:
      - dokploy-network

  lago-redis:
    image: redis:7-alpine
    container_name: lago-redis
    restart: always
    command: redis-server --save 60 1 --loglevel warning
    volumes:
      - lago_redis_vol:/data
    networks:
      - dokploy-network

  lago-migrate:
    image: getlago/api:v1.17.0
    container_name: lago-migrate
    command: bundle exec rails db:migrate
    depends_on:
      - lago-db
      - lago-redis
    environment:
      - DATABASE_URL=postgresql://lago:lago_password_2025@lago-db:5432/lago
      - LAGO_REDIS_URL=redis://lago-redis:6379/1
      - RAILS_ENV=production
    networks:
      - dokploy-network

  lago-api:
    image: getlago/api:v1.17.0
    container_name: lago-api
    restart: always
    depends_on:
      - lago-db
      - lago-redis
    environment:
      - DATABASE_URL=postgresql://lago:lago_password_2025@lago-db:5432/lago
      - LAGO_REDIS_URL=redis://lago-redis:6379/1
      - LAGO_API_URL=https://billing-api.bizoholic.net
      - LAGO_FRONT_URL=https://billing.bizoholic.net
      - SECRET_KEY_BASE=85acd00b662a82aa2132d7639de8e6de655dcfe2d568abd05fbd069de0092dd4
      - ENCRYPTION_PRIMARY_KEY=2f9700e1e19ffbf8f970fa260e356c2b606ac09f2ee71ecd2a630936209337fb
      - ENCRYPTION_DETERMINISTIC_KEY=92ae2adaeb2093deb1e41a61ccb9b6f4fe5ec94b6b373f74c976b6b199c4efa6
      - ENCRYPTION_KEY_DERIVATION_SALT=135f8017cd510bbea948b0b06109c2d479f6b3f3fcb3e4d4181bf478715b85ba
      - RAILS_ENV=production
      - RAILS_LOG_TO_STDOUT=true
    volumes:
      - lago_keys_vol:/app/keys
    labels:
      - traefik.enable=true
      - traefik.docker.network=dokploy-network
      - traefik.http.routers.lago-api.rule=Host(`billing-api.bizoholic.net`)
      - traefik.http.routers.lago-api.entrypoints=web
      - traefik.http.routers.lago-api-secure.rule=Host(`billing-api.bizoholic.net`)
      - traefik.http.routers.lago-api-secure.entrypoints=websecure
      - traefik.http.routers.lago-api-secure.tls.certresolver=letsencrypt
      - traefik.http.services.lago-api.loadbalancer.server.port=3000
    networks:
      - dokploy-network

  lago-worker:
    image: getlago/api:v1.17.0
    container_name: lago-worker
    restart: always
    command: bundle exec sidekiq
    depends_on:
      - lago-db
      - lago-redis
    environment:
      - DATABASE_URL=postgresql://lago:lago_password_2025@lago-db:5432/lago
      - LAGO_REDIS_URL=redis://lago-redis:6379/1
      - SECRET_KEY_BASE=85acd00b662a82aa2132d7639de8e6de655dcfe2d568abd05fbd069de0092dd4
      - ENCRYPTION_PRIMARY_KEY=2f9700e1e19ffbf8f970fa260e356c2b606ac09f2ee71ecd2a630936209337fb
      - ENCRYPTION_DETERMINISTIC_KEY=92ae2adaeb2093deb1e41a61ccb9b6f4fe5ec94b6b373f74c976b6b199c4efa6
      - ENCRYPTION_KEY_DERIVATION_SALT=135f8017cd510bbea948b0b06109c2d479f6b3f3fcb3e4d4181bf478715b85ba
      - RAILS_ENV=production
    volumes:
      - lago_keys_vol:/app/keys
    networks:
      - dokploy-network

  lago-front:
    image: getlago/front:v1.17.0
    container_name: lago-front
    restart: always
    environment:
      - LAGO_API_URL=https://billing-api.bizoholic.net/api/v1
    labels:
      - traefik.enable=true
      - traefik.docker.network=dokploy-network
      - traefik.http.routers.lago-front.rule=Host(`billing.bizoholic.net`)
      - traefik.http.routers.lago-front.entrypoints=web
      - traefik.http.routers.lago-front-secure.rule=Host(`billing.bizoholic.net`)
      - traefik.http.routers.lago-front-secure.entrypoints=websecure
      - traefik.http.routers.lago-front-secure.tls.certresolver=letsencrypt
      - traefik.http.services.lago-front.loadbalancer.server.port=80
    networks:
      - dokploy-network

volumes:
  lago_db_vol:
    external: true
  lago_redis_vol:
    external: true
  lago_keys_vol:
    external: true

networks:
  dokploy-network:
    external: true
    name: dokploy-network
