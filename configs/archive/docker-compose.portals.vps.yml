services:
  client-portal:
    image: ghcr.io/bizoholic-digital/bizosaas-platform/client-portal:staging
    container_name: bizosaas-client-portal-staging
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_BASE_URL=https://api.bizoholic.net
      - NEXT_PUBLIC_STRIPE_PUBLIC_KEY=${NEXT_PUBLIC_STRIPE_PUBLIC_KEY}
      - NEXTAUTH_URL=https://app.bizoholic.net/login
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - AUTHENTIK_ISSUER=${AUTHENTIK_ISSUER}
      - AUTHENTIK_CLIENT_ID=${AUTHENTIK_CLIENT_ID}
      - AUTHENTIK_CLIENT_SECRET=${AUTHENTIK_CLIENT_SECRET}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - HOSTNAME=0.0.0.0
      - BRAIN_GATEWAY_URL=http://bizosaas-brain-staging:8000
    networks:
      - dokploy-network
      - brain-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.4'
          memory: 512M
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3000/api/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.client-portal-stg.rule=Host(`app.bizoholic.net`)"
      - "traefik.http.routers.client-portal-stg.entrypoints=websecure"
      - "traefik.http.routers.client-portal-stg.tls.certresolver=letsencrypt"
      - "traefik.http.routers.client-portal-stg.priority=1000"
      - "traefik.http.services.client-portal-stg-svc.loadbalancer.server.port=3000"
      - "traefik.docker.network=dokploy-network"

  bizoholic-frontend:
    image: ghcr.io/bizoholic-digital/bizosaas-platform/bizoholic-frontend:staging
    container_name: bizoholic-frontend-staging
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_BASE_URL=https://api.bizoholic.net
      - NEXT_PUBLIC_BRAIN_API_URL=http://bizosaas-brain-staging:8000
    networks:
      - dokploy-network
      - brain-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.4'
          memory: 512M
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3000" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.bizoholic-frontend.rule=Host(`bizoholic.net`) || Host(`www.bizoholic.net`)"
      - "traefik.http.routers.bizoholic-frontend.entrypoints=websecure"
      - "traefik.http.routers.bizoholic-frontend.tls.certresolver=letsencrypt"
      - "traefik.http.services.bizoholic-frontend-svc.loadbalancer.server.port=3000"
      - "traefik.docker.network=dokploy-network"

networks:
  dokploy-network:
    external: true
  brain-network:
    external: true
