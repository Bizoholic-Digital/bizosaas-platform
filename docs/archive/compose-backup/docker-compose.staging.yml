services:
  # Base Infrastructure
  # Postgres and Redis are now external (Neon DB / Redis Cloud)

  # Brain Gateway
  brain-gateway:
    build:
      context: ./bizosaas-brain-core/brain-gateway
      dockerfile: Dockerfile
    environment:
      - DATABASE_URL=${VECTOR_DB_URL}
      - REDIS_URL=${REDIS_URL:-redis://default:Gt7QxXA4ybMzYzD9e6KIBULfnv1IU6f9@redis-10690.c264.ap-south-1-1.ec2.cloud.redislabs.com:10690/0}
      - DISABLE_AUTH=true
      - VECTOR_DB_URL=${VECTOR_DB_URL}
      - LAGO_API_URL=http://lago-api:3000
      - LAGO_API_KEY=df1933ae-50fd-4c06-972c-1b092be9d96b
    ports:
      - "8000:8000"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.brain-gateway.rule=Host(`api.bizoholic.net`)"
      - "traefik.http.routers.brain-gateway.entrypoints=websecure"
      - "traefik.http.routers.brain-gateway.tls.certresolver=letsencrypt"
      - "traefik.http.services.brain-gateway.loadbalancer.server.port=8000"
    networks:
      - dokploy-network
      - brain-network

  # Client Portal (port 3003)
  client-portal:
    build:
      context: ./portals/client-portal
      dockerfile: Dockerfile.dev
    environment:
      - NEXT_PUBLIC_API_URL=https://api.bizoholic.net
      - NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_ZWFzeS1rb2RpYWstNzguY2xlcmsuYWNjb3VudHMuZGV2JA
      - CLERK_SECRET_KEY=sk_test_hsYzctm4bTgGxWB5Z6f7GT2OgnJ1biw7t21Q8NJvjv
      - PORT=3003
    ports:
      - "3003:3003"
    command: npx next dev -p 3003 -H 0.0.0.0
    depends_on:
      - brain-gateway
    networks:
      - dokploy-network

  # Admin Dashboard (port 3004)
  admin-dashboard:
    build:
      context: ./portals/admin-dashboard
      dockerfile: Dockerfile.dev
    environment:
      - NEXT_PUBLIC_API_URL=https://api.bizoholic.net
      - NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_ZWFzeS1rb2RpYWstNzguY2xlcmsuYWNjb3VudHMuZGV2JA
      - CLERK_SECRET_KEY=sk_test_hsYzctm4bTgGxWB5Z6f7GT2OgnJ1biw7t21Q8NJvjv
      - PORT=3004
    ports:
      - "3004:3004"
    command: npx next dev -p 3004 --hostname 0.0.0.0
    depends_on:
      - brain-gateway
    networks:
      - dokploy-network

networks:
  dokploy-network:
    external: true
  brain-network:
    external: true
