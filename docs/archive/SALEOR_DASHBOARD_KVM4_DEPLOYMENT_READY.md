# Saleor Dashboard Deployment - KVM4 Frontend-Services

**Server:** KVM4 (72.60.219.244)
**Project:** frontend-services (Already configured by user)
**Status:** Ready for deployment
**Date:** November 3, 2025

---

## ‚úÖ Verified Infrastructure (KVM4)

### Current Services Running

**Saleor API (Backend):**
- Container: `backend-saleor-api.1.2b4cetxidpwq0i5l3nbgmi10p`
- Image: `ghcr.io/saleor/saleor:3.20`
- Status: Running (Up 6 days)
- **Internal IP: `10.0.1.47`** ‚Üê Use this for API_URL
- Port: `8000/tcp`
- Network: `dokploy-network`

**Saleor Dashboard:**
- Status: ‚ùå NOT DEPLOYED (configured in Dokploy, awaiting deployment)
- Project: `frontend-services` ‚úÖ (Correct location)

---

## üîç Configuration Verification

Since you've already configured the saleor-dashboard in Dokploy under "frontend-services" project, please verify these critical settings before deploying:

### ‚úÖ **CRITICAL SETTINGS CHECKLIST**

#### 1. **General Tab**
```yaml
Service Name: saleor-dashboard
Service Type: Docker Image
Project: frontend-services  # ‚úÖ You've set this correctly
```

#### 2. **Image Tab**
```yaml
Image: ghcr.io/saleor/saleor-dashboard:latest
Registry: Public (no auth needed)
Pull Policy: Always
```

#### 3. **Network ‚Üí Ports Tab**
```yaml
Published Port: 9000      # External port on KVM4
Container Port: 80        # Internal Nginx port (cannot change)
Protocol: TCP
Publish: ‚úÖ Enabled
```

**Important:**
- Container Port MUST be `80` (official image uses Nginx on port 80)
- Published Port `9000` is recommended (available port)

#### 4. **Environment Tab** ‚ö†Ô∏è **MOST CRITICAL**
```yaml
API_URL=http://10.0.1.47:8000/graphql/
```

**‚ö†Ô∏è VERIFY THIS EXACT VALUE:**
- ‚úÖ **CORRECT:** `http://10.0.1.47:8000/graphql/`
- ‚ùå **WRONG:** `http://localhost:8000/graphql/`
- ‚ùå **WRONG:** `http://172.31.0.1:8000/graphql/`
- ‚ùå **WRONG:** `http://saleor-api:8000/graphql/`

**Why 10.0.1.47?**
- This is the actual internal Docker IP of the Saleor API container on KVM4
- Verified via: `docker inspect backend-saleor-api...`
- Dashboard needs this internal IP to connect

#### 5. **Routing ‚Üí Domain Tab**
```yaml
Host: stg.coreldove.com
Path: /dashboard
Container Port: 80
HTTPS: ‚úÖ Enabled
Certificate Resolver: letsencrypt
```

**Domain Configuration:**
- Full URL will be: `https://stg.coreldove.com/dashboard/`
- Traefik will handle SSL with Let's Encrypt
- Path prefix `/dashboard` will be stripped by middleware

**Traefik Labels (Auto-generated by Dokploy):**
```yaml
traefik.enable=true
traefik.http.routers.saleor-dashboard.rule=Host(`stg.coreldove.com`) && PathPrefix(`/dashboard`)
traefik.http.routers.saleor-dashboard.entrypoints=websecure
traefik.http.routers.saleor-dashboard.tls=true
traefik.http.routers.saleor-dashboard.tls.certresolver=letsencrypt
traefik.http.services.saleor-dashboard.loadbalancer.server.port=80

# Strip /dashboard prefix for the container
traefik.http.middlewares.saleor-dashboard-stripprefix.stripprefix.prefixes=/dashboard
traefik.http.routers.saleor-dashboard.middlewares=saleor-dashboard-stripprefix
```

#### 6. **Resources Tab**
```yaml
CPU Limit: 0.5 cores
Memory Limit: 512 MB
Memory Reservation: 256 MB
```

**Rationale:** Static React SPA served by Nginx - lightweight resource needs

#### 7. **Health Check Tab**
```yaml
Test Command: CMD curl -f http://localhost:80/ || exit 1
Interval: 30s
Timeout: 10s
Retries: 3
Start Period: 40s
```

---

## üöÄ Deployment Steps

### Step 1: Final Configuration Verification (2 minutes)

1. Open Dokploy UI: `https://automationhub-n8n-91feb0-194-238-16-237.traefik.me`
2. Login with credentials from `credentials.md`
3. Navigate to **frontend-services** project
4. Find **saleor-dashboard** service
5. Click on the service to open settings

**Verify Each Tab:**
- [ ] General ‚Üí Service name is "saleor-dashboard"
- [ ] Image ‚Üí `ghcr.io/saleor/saleor-dashboard:latest`
- [ ] Ports ‚Üí Published `9000`, Container `80`
- [ ] **Environment ‚Üí API_URL is `http://10.0.1.47:8000/graphql/`** ‚ö†Ô∏è CRITICAL
- [ ] Domain ‚Üí Host `stg.coreldove.com`, Path `/dashboard`
- [ ] Resources ‚Üí Limits set
- [ ] Health Check ‚Üí Configured

### Step 2: Deploy Dashboard (2-3 minutes)

1. After verification, click the **"Deploy"** button (usually top-right)
2. Dokploy will:
   - Pull the official Saleor Dashboard image from GitHub Container Registry
   - Create container with your configuration
   - Configure Traefik routing
   - Start health checks
3. Monitor deployment progress in Dokploy UI
4. Wait for container status to show **"Running"**

**Expected Timeline:**
- Image pull: 30-60 seconds
- Container start: 10-20 seconds
- Health check pass: 30-40 seconds
- **Total: ~2-3 minutes**

### Step 3: Verification (5 minutes)

#### A. Check Container Status
```bash
# Via Dokploy UI:
# - Navigate to frontend-services ‚Üí saleor-dashboard
# - Status should show "Running" with green indicator
# - Health check should show "Healthy"

# Via SSH (optional):
ssh root@72.60.219.244
docker ps | grep saleor-dashboard

# Expected output:
# [container_id]  ghcr.io/saleor/saleor-dashboard:latest  Up X minutes  80/tcp
```

#### B. Test Direct Port Access
```bash
# From KVM4 server:
curl -I http://localhost:9000/

# Expected: HTTP/1.1 200 OK
```

#### C. Test Domain Access
```bash
# From your local machine or any browser:
curl -I https://stg.coreldove.com/dashboard/

# Expected: HTTP/2 200
# Traefik should redirect HTTP ‚Üí HTTPS automatically
```

#### D. Browser Test (Most Important)
1. Open browser: `https://stg.coreldove.com/dashboard/`
2. **Expected:** Saleor Dashboard login page
3. **Check:**
   - Page loads completely
   - All CSS/JS assets load (check browser DevTools ‚Üí Network tab)
   - No errors in browser Console
   - Login form is visible
4. **Try Login:**
   - Use Saleor admin credentials
   - Should attempt to connect to `http://10.0.1.47:8000/graphql/`
   - Check Network tab for GraphQL requests

#### E. Verify Logs
```bash
# Via Dokploy UI:
# - Navigate to saleor-dashboard ‚Üí Logs tab
# - Should see Nginx startup messages
# - No errors in logs

# Via SSH (optional):
docker logs [saleor-dashboard-container-id] 2>&1 | tail -50
```

---

## üîß Troubleshooting

### Issue 1: Container Won't Start

**Symptoms:** Status shows "Exited" or "Restarting"

**Check:**
```bash
ssh root@72.60.219.244
docker logs [container-id]
```

**Common Causes:**
- Port 9000 already in use ‚Üí Change published port to 9001
- Image pull failed ‚Üí Check internet connectivity
- Wrong image name ‚Üí Verify `ghcr.io/saleor/saleor-dashboard:latest`

### Issue 2: 502 Bad Gateway

**Symptoms:** `https://stg.coreldove.com/dashboard/` returns 502

**Diagnosis:**
```bash
# 1. Check container is running
docker ps | grep saleor-dashboard

# 2. Check Traefik can reach container
docker logs traefik 2>&1 | grep saleor-dashboard

# 3. Test direct container access
curl http://localhost:9000/
```

**Common Causes:**
- Container not running ‚Üí Restart deployment
- Wrong Traefik configuration ‚Üí Check labels
- Health check failing ‚Üí Check health check command

### Issue 3: Dashboard Loads but Can't Login

**Symptoms:** Login page loads, but login fails with "Network error"

**Diagnosis:**
1. Open browser DevTools ‚Üí Console tab
2. Look for errors related to API connection
3. Check Network tab for failed requests to `/graphql/`

**Common Causes:**
- **Wrong API_URL environment variable** ‚Üê MOST COMMON
  - Should be: `http://10.0.1.47:8000/graphql/`
  - NOT: `http://localhost:8000/graphql/`
- CORS not configured in Saleor Core
- Saleor API not accessible

**Fix:**
1. Verify API_URL in Dokploy:
   ```bash
   docker inspect [saleor-dashboard-container] | grep API_URL
   ```
2. If wrong, update environment variable in Dokploy and redeploy
3. Test Saleor API directly:
   ```bash
   curl http://10.0.1.47:8000/graphql/ \
     -H "Content-Type: application/json" \
     -d '{"query":"{ shop { name } }"}'
   ```

### Issue 4: CORS Errors in Browser Console

**Symptoms:** Browser console shows:
```
Access to fetch at 'http://10.0.1.47:8000/graphql/' from origin 'https://stg.coreldove.com' has been blocked by CORS policy
```

**Cause:** Saleor Core hasn't whitelisted the dashboard domain

**Fix:**
1. SSH to KVM4:
   ```bash
   ssh root@72.60.219.244
   ```
2. Find Saleor Core container environment:
   ```bash
   docker inspect backend-saleor-api.1.2b4cetxidpwq0i5l3nbgmi10p | grep ALLOWED_CLIENT_HOSTS
   ```
3. Add dashboard domain to Saleor Core environment variables in Dokploy:
   ```yaml
   ALLOWED_CLIENT_HOSTS=stg.coreldove.com,localhost
   ```
4. Restart Saleor Core service

### Issue 5: Static Assets 404

**Symptoms:** Dashboard page loads but CSS/JS files return 404

**Diagnosis:**
```bash
# Check asset paths in browser DevTools Network tab
# Look for failed requests like:
# https://stg.coreldove.com/dashboard/static/css/main.css ‚Üí 404
```

**Cause:** Strip prefix middleware not applied

**Fix:**
1. Verify Traefik labels in Dokploy
2. Ensure middleware is configured:
   ```yaml
   traefik.http.middlewares.saleor-dashboard-stripprefix.stripprefix.prefixes=/dashboard
   traefik.http.routers.saleor-dashboard.middlewares=saleor-dashboard-stripprefix
   ```
3. Redeploy if needed

---

## üìä Success Criteria

‚úÖ **Deployment Successful When:**

1. Container shows "Running" status in Dokploy
2. Health check passes (green indicator)
3. `https://stg.coreldove.com/dashboard/` returns HTTP 200
4. Dashboard login page loads with all styles/scripts
5. Can successfully login with Saleor admin credentials
6. Dashboard can query and display store data
7. No CORS errors in browser console
8. No errors in container logs
9. Resource usage under limits (< 512MB RAM, < 0.5 CPU)

---

## üéØ Post-Deployment: Next Steps

After successful dashboard deployment, proceed with **Webhook CrewAI Integration**:

1. **Implement Webhook Endpoints** in Brain Gateway
   - See: [SALEOR_WEBHOOK_CREWAI_INTEGRATION_PLAN.md](./SALEOR_WEBHOOK_CREWAI_INTEGRATION_PLAN.md)
   - Create `saleor_webhooks.py` with all webhook handlers
   - Implement CrewAI crew classes

2. **Configure Webhooks in Saleor Dashboard**
   - Login to: `https://stg.coreldove.com/dashboard/`
   - Navigate: Configuration ‚Üí Webhooks
   - Add 5 webhook configurations:
     - ORDER_CREATED ‚Üí Order Fulfillment Crew
     - ORDER_UPDATED ‚Üí Status handling
     - PRODUCT_CREATED ‚Üí Product SEO Crew
     - PRODUCT_UPDATED ‚Üí SEO/Procurement Crew
     - CUSTOMER_CREATED ‚Üí Customer Service Crew

3. **Test End-to-End Integration**
   - Create test order in dashboard
   - Verify webhook fires to Brain Gateway
   - Confirm CrewAI crew executes
   - Check autonomous operations complete

4. **Monitor and Optimize**
   - Track webhook processing times
   - Monitor CrewAI execution success rates
   - Optimize agent prompts based on results

---

## üìñ Related Documentation

1. **[SALEOR_DASHBOARD_CONFIGURATION_VERIFICATION.md](./SALEOR_DASHBOARD_CONFIGURATION_VERIFICATION.md)**
   - Detailed configuration guide
   - Troubleshooting reference
   - Architecture diagrams

2. **[SALEOR_WEBHOOK_CREWAI_INTEGRATION_PLAN.md](./SALEOR_WEBHOOK_CREWAI_INTEGRATION_PLAN.md)**
   - Complete webhook implementation code
   - CrewAI crew implementations
   - Testing procedures

3. **[SALEOR_DASHBOARD_COMPLETE_DEPLOYMENT_GUIDE.md](./SALEOR_DASHBOARD_COMPLETE_DEPLOYMENT_GUIDE.md)**
   - Comprehensive deployment guide
   - Post-deployment verification

---

## üö¶ Quick Reference

**Dokploy UI:**
```
https://automationhub-n8n-91feb0-194-238-16-237.traefik.me
Project: frontend-services
Service: saleor-dashboard
```

**Dashboard URL (After Deployment):**
```
https://stg.coreldove.com/dashboard/
```

**Critical Configuration:**
```yaml
API_URL: http://10.0.1.47:8000/graphql/
Container Port: 80
Published Port: 9000
Domain: stg.coreldove.com/dashboard
```

**SSH Access:**
```bash
ssh root@72.60.219.244
Password: &k3civYG5Q6YPb
```

**Check Status:**
```bash
docker ps | grep saleor-dashboard
docker logs [container-id]
```

---

## ‚úÖ Ready to Deploy!

Your configuration in Dokploy is ready. Just:

1. **Verify** the API_URL is `http://10.0.1.47:8000/graphql/`
2. **Click Deploy** button in Dokploy UI
3. **Wait** 2-3 minutes for deployment
4. **Test** at `https://stg.coreldove.com/dashboard/`

**Status:** ‚úÖ Configuration Complete - Ready for Deployment
**Server:** KVM4 (72.60.219.244)
**Project:** frontend-services
**Next:** Click Deploy ‚Üí Verify ‚Üí Implement Webhooks

---

**Date:** November 3, 2025
**Team:** BizOSaaS Platform Team
**Deployment Method:** Dokploy UI (Official Saleor Dashboard Image)
