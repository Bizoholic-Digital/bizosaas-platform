# ═══════════════════════════════════════════════════════════════════════════
# BizOSaaS Core Services Stack
# ═══════════════════════════════════════════════════════════════════════════
# Contains: API Gateway, Auth Service, MCP Servers
# Deploy this AFTER infrastructure stack
# ═══════════════════════════════════════════════════════════════════════════

services:
  # ========================================
  # API Gateway
  # ========================================
  brain-gateway:
    build:
      context: ../brain-gateway
      dockerfile: Dockerfile
    container_name: bizosaas-brain-staging
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - TEMPORAL_ADDRESS=${TEMPORAL_ADDRESS}
      - TEMPORAL_NAMESPACE=${TEMPORAL_NAMESPACE}
      - VAULT_URL=${VAULT_URL:-http://vault:8200}
      - VAULT_TOKEN=${VAULT_TOKEN}
      - SHOPIFY_CLIENT_ID=${SHOPIFY_CLIENT_ID}
      - SHOPIFY_CLIENT_SECRET=${SHOPIFY_CLIENT_SECRET}
      - SHOPIFY_APP_URL=${SHOPIFY_APP_URL}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - LANGCACHE_API_KEY=${LANGCACHE_API_KEY}
      - AI_AGENTS_URL=http://ai-agents:8000
    networks:
      - dokploy-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=dokploy-network"
      - "traefik.http.routers.brain-gateway.rule=Host(`api.bizoholic.net`)"
      - "traefik.http.routers.brain-gateway.entrypoints=websecure"
      - "traefik.http.routers.brain-gateway.tls.certresolver=letsencrypt"
      - "traefik.http.services.brain-gateway.loadbalancer.server.port=8000"
    restart: unless-stopped

  # ========================================
  # MCP Server (GitHub Integration)
  # ========================================
  github-mcp:
    image: ghcr.io/bizoholic-digital/bizosaas-platform/github-mcp:staging
    container_name: brain-mcp-github
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - GITHUB_PERSONAL_ACCESS_TOKEN=${GITHUB_TOKEN:-}
    networks:
      - dokploy-network
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 256M
    restart: unless-stopped

  # ========================================
  # AI Agents Service
  # ========================================
  ai-agents:
    image: ghcr.io/bizoholic-digital/bizosaas-platform/ai-agents:staging
    container_name: bizosaas-ai-agents-staging
    build:
      context: ../ai-agents
      dockerfile: Dockerfile
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - VAULT_ADDR=${VAULT_URL}
      - VAULT_TOKEN=${VAULT_TOKEN}
      - BRAIN_API_URL=http://brain-gateway:8000
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
    networks:
      - dokploy-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    restart: unless-stopped

# ═══════════════════════════════════════════════════════════════════════════
# Networks
# ═══════════════════════════════════════════════════════════════════════════
networks:
  dokploy-network:
    external: true
