services:
  authentik-server:
    image: ghcr.io/goauthentik/server:2024.12.3
    restart: unless-stopped
    command: server
    environment:
      - AUTHENTIK_POSTGRESQL__HOST=dokploy-postgres
      - AUTHENTIK_POSTGRESQL__NAME=authentik
      - AUTHENTIK_POSTGRESQL__USER=authentik
      - AUTHENTIK_POSTGRESQL__PASSWORD=${AUTHENTIK_POSTGRESQL__PASSWORD}
      - AUTHENTIK_POSTGRESQL__PORT=5432
      - AUTHENTIK_REDIS__HOST=dokploy-redis
      - AUTHENTIK_REDIS__PORT=6379
      - AUTHENTIK_REDIS__DB=1
      - AUTHENTIK_SECRET_KEY=${AUTHENTIK_SECRET_KEY}
      - AUTHENTIK_BOOTSTRAP_PASSWORD=${AUTHENTIK_BOOTSTRAP_PASSWORD}
      - AUTHENTIK_BOOTSTRAP_TOKEN=${AUTHENTIK_BOOTSTRAP_TOKEN}
      - AUTHENTIK_LOG_LEVEL=info
      - AUTHENTIK_ERROR_REPORTING__ENABLED=false
    volumes:
      - authentik-media:/media
      - authentik-custom-templates:/templates
    networks:
      - dokploy-network
    healthcheck:
      test: [ "CMD-SHELL", "ak healthcheck || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    labels:
      - traefik.enable=true
      - traefik.docker.network=dokploy-network
      # HTTP Router (Port 80) - NO REDIRECT FOR NOW TO ALLOW ACME CHALLENGE
      - traefik.http.routers.authentik-sso.rule=Host(`sso.bizoholic.net`) || Host(`auth-sso.bizoholic.net`)
      - traefik.http.routers.authentik-sso.entrypoints=web
      # HTTPS Router (Port 443)
      - traefik.http.routers.authentik-sso-secure.rule=Host(`sso.bizoholic.net`) || Host(`auth-sso.bizoholic.net`)
      - traefik.http.routers.authentik-sso-secure.entrypoints=websecure
      - traefik.http.routers.authentik-sso-secure.tls.certresolver=letsencrypt
      - traefik.http.routers.authentik-sso-secure.service=authentik-sso-svc
      - traefik.http.services.authentik-sso-svc.loadbalancer.server.port=9000

  authentik-worker:
    image: ghcr.io/goauthentik/server:2024.12.3
    restart: unless-stopped
    command: worker
    environment:
      - AUTHENTIK_POSTGRESQL__HOST=dokploy-postgres
      - AUTHENTIK_POSTGRESQL__NAME=authentik
      - AUTHENTIK_POSTGRESQL__USER=authentik
      - AUTHENTIK_POSTGRESQL__PASSWORD=${AUTHENTIK_POSTGRESQL__PASSWORD}
      - AUTHENTIK_POSTGRESQL__PORT=5432
      - AUTHENTIK_REDIS__HOST=dokploy-redis
      - AUTHENTIK_REDIS__PORT=6379
      - AUTHENTIK_REDIS__DB=1
      - AUTHENTIK_SECRET_KEY=${AUTHENTIK_SECRET_KEY}
      - AUTHENTIK_LOG_LEVEL=info
      - AUTHENTIK_ERROR_REPORTING__ENABLED=false
    volumes:
      - authentik-media:/media
      - authentik-certs:/certs
      - authentik-custom-templates:/templates
    networks:
      - dokploy-network
    healthcheck:
      test: [ "CMD-SHELL", "ak healthcheck || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

volumes:
  authentik-media:
    driver: local
  authentik-certs:
    driver: local
  authentik-custom-templates:
    driver: local

networks:
  dokploy-network:
    external: true
    name: dokploy-network
