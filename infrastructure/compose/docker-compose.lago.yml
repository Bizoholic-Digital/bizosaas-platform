services:
  lago-api:
    image: getlago/api:v1.17.0
    container_name: lago-api
    command: >
      /bin/sh -c "mkdir -p /app/keys && ruby -rbase64 -e 'File.write(\"/app/keys/private.pem\", Base64.decode64(ENV[\"LAGO_RSA_PRIVATE_KEY\"])); File.write(\"/app/keys/public.pem\", Base64.decode64(ENV[\"LAGO_RSA_PUBLIC_KEY\"]))' && echo \"RsaPrivateKey = OpenSSL::PKey::RSA.new(File.read('/app/keys/private.pem')); RsaPublicKey = RsaPrivateKey.public_key\" > config/initializers/rsa_keys.rb && ./scripts/start.sh"
    environment:
      - DATABASE_URL=postgresql://neondb_owner:npg_puEbTnkSO9F8@ep-gentle-flower-a15rdh2r-pooler.ap-southeast-1.aws.neon.tech/neondb?sslmode=require
      - REDIS_URL=redis://default:Gt7QxXA4ybMzYzD9e6KIBULfnv1IU6f9@redis-10690.c264.ap-south-1-1.ec2.cloud.redislabs.com:10690/0
      - LAGO_REDIS_URL=redis://default:Gt7QxXA4ybMzYzD9e6KIBULfnv1IU6f9@redis-10690.c264.ap-south-1-1.ec2.cloud.redislabs.com:10690/0
      - LAGO_API_URL=https://billing-api.bizoholic.net
      - SECRET_KEY_BASE=85acd00b662a82aa2132d7639de8e6de655dcfe2d568abd05fbd069de0092dd4
      - ENCRYPTION_PRIMARY_KEY=2f9700e1e19ffbf8f970fa260e356c2b606ac09f2ee71ecd2a630936209337fb
      - ENCRYPTION_DETERMINISTIC_KEY=92ae2adaeb2093deb1e41a61ccb9b6f4fe5ec94b6b373f74c976b6b199c4efa6
      - ENCRYPTION_KEY_DERIVATION_SALT=135f8017cd510bbea948b0b06109c2d479f6b3f3fcb3e4d4181bf478715b85ba
      - RAILS_ENV=production
      - RAILS_LOG_TO_STDOUT=true
      - LAGO_RSA_PRIVATE_KEY=LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2UUlCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktjd2dnU2pBZ0VBQW9JQkFRQ3A0T0pXR2lSN0VqdWMKMURxVmFRV3RNcHFpU3hydDVHRUcxS3VGV1dwcDdJRVhMTzZ3WXQ0VkJvYmhaU09aYWkvbnVwVldYL1FxZmMwWgp1WHN0a2EvZ1Job05SY0xQSE5hZS9TWFpYZnc1MzQwbGE0NytXdFY3ckVNVHJ3THloSFlCbXpzN1hLa0ZiSi9nCnFnWDFRYi9mTWJGcGxpc0VPN3dzKzZhd0F0ZFI1L0hwYVdqdUR1NEg2TDBHRmViQjFXVWJHZGU5WmpIdkZIVTMKVVFCd0Znblk5YnhTcDdER0xzemxiSWh4cWhQZ2ErdE5vRHM0RjArcVE3OFRqWElvUWVudU1ST1ZTSHlhMjVWRQozR3J1LzRlOEh2SmRMUW5yWU0wRjh2YjRYRXU4WjkvWnRFRzVmYVlBMlMxNU5lWGpUdGd6NGN2WUZzZE5OV1lZCkVVUEVkQUFsQWdNQkFBRUNnZ0VBU1lGbXZqWHFvaHdtRWpxY3JNaTRMWlN2WjFrVEttdCs5a3N3ZW05UnhjcVIKb3ZzTXZ1TFEwSTAxOExKb0lIcGJoeXZyY1dmc2lUUk0rbndSQ2dzM2JGWTQ4SlJHY29LNmRTbjVaaUF1UXNaeAoxd2ErNVYxZGNYbDh2cmdrRU5iekRzZmg3ZEl1eW91UmRFOXRhNDJMSGVMdEx0Qk5CYlJwUEplWkxTRFZsWGtQCmM2RFp4ejF1UVg4V1J5ek1RdU5nMnh1MnpNNFBBMlFwOWNzcmJQWHpWcnhyTmwwcnFqcGJHRENibjVKZnQrSGoKRFcvdFdKWVJhKzlSOFN2OHhaYXh3SDdtQ08vOWxHbW1mRmRZUFB4UHIzempRQmpBeFhiRnExZzhyb0lqcXNVRgpnR2Rsd1BGbS9FL0NPRE5FZ0ZoTCs2STYwZGMvdVJEekRUWFhBaWxnQXdLQmdRRG5sOHhHRU9neFRBanpWcGJaCjRJS0JacWNLYTVkd0loWFh4VGdqdWdGTzVJN3g2cG80MERZOXNkbDlVeTFWN1ZRa1ZadnVoa25hTkN5cHM0bVcKc0Z4c3AxSTZEdFU1WmVjWXlaQVZPNFZBeVFtWXRCUUU4dWpaUkE5RUgvcDJNY0krRGdVWDV3bGtCemJDU29ZOQpMK3JNWjMvVmhPU3NvVmtxSmFZZk5reHpTd0tCZ1FDN3lCTmdQZDNXNXFsd2NnV3ZGUEFUWTRVYk5zZkIvYVNICnJqZy94ajNTT2VURVJRZjNUT3VHYjJ6dVBQcGVEQkVYeHNJR2hMY01PZ0prczFxYnhObzd2NUtWbGNMRXRXU2UKY1lwM2FvbnJvTkxEMjFZVlVDWVB5WGsxZU9tVzZ3RitqcDQwSDc4Nlh6bHA5L0ZsWjAyMWQ5WmErMld4R1l4cgpqcG4xT21YRVR3S0JnUURCYy9PV3M1akJWUnBFNmhlb2QvbUx6Z3ZLa0lVM2pjRmhNOFRwVXY2MHdBY0gzVWhtCkhNYXlVbFd5Y2tCMGZvTEN0eUJCNXJyYUlxc01Ob1MvOHlIQlFTTldpLzFnck5hVnhna3RNMExrRXdxSkhDTjgKM3N2U2NSK3ZjR2J2UkRGVlZMQzhmcWxCZlNVb3RzZmJaS05saXk4bFZKVVAvdGRVZFk2R2svelljUUtCZ0VpbgpuLytUMEZxT3dxNVVINmpmVkFoY2NDcllaaS9Ed0w0U2hZYi9YL29RRmxodVVTZTVKa1BNcHZ3Q3NlaGppTldIClBKa2pEbVAzcWVkbWtiOUZTaDdsLzRSSy9xSDNnU2Znekc5cDFGVkwwMkNlWTg4NVJKREZKbFd2SThvVndXMUQKSnlrSnc0YUZRNFNodjArNXlaSlYvS1VWTWdKMDNTVGNkdXN3SGlIM0FvR0FaTTFyS2hBbHB2aGcxbHdVTnoragpHY0srcGozOUlrY1EwT3Y5L1kxL1A1M3ZiODFKMXp6eFBIQ1VnM0V3cDFPQnZGV0NndldZenlHWUZ3WWtCQjRRCkZ1Q2VhVVhJbi80R0VBNTgwdkI2U1RMOVF5SzJhZ1FLKzErLzJVMk54cXczSXRHUGszbk00cnVraUhDcHdYNHyKQm9hckRxL2RkbGMrNDVHWFdhUzFaTEU9Ci0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS0K
      - LAGO_RSA_PUBLIC_KEY=LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUFxZURpVmhva2V4STduTlE2bFdrRgpyVEthb2tzYTdlUmhCdFNyaFZscWFleUJGeXp1c0dMZUZRYUc0V1VqbVdvdjU3cVZWbC8wS24zTkdibDdMWkd2CjRFWWFEVVhDenh6V252MGwyVjM4T2QrTkpXdU8vbHJWZTZ4REU2OEM4b1IyQVpzN08xeXBCV3lmNEtvRjlVRy8KM3pHeGFaWXJCRHU4TFB1bXNBTFhVZWZ4NldsbzdnN3VCK2k5QmhYbXdkVmxHeG5YdldZeDd4UjFOMUVBY0JZSgoyUFc4VXFld3hpN001V3lJY2FvVDRHdnJUYUE3T0JkUHFrTy9FNDF5S0VIcDdqRVRsVWg4bXR1VlJOeHE3ditICnZCN3lYUzBKNjJETkJmTDIrRnhMdkdmZjJiUkJ1WDJtQU5rdGVUWGw0MDdZTStITDJCYkhUVFZtR0JGRHhIUUEKSlFJREFRQUIKLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tCg==
    volumes:
      - lago_keys_vol:/app/keys
    networks:
      - dokploy-network
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 1024M
        reservations:
          cpus: "0.25"
          memory: 512M
    labels:
      - traefik.enable=true
      - traefik.docker.network=dokploy-network
      # HTTP Router (Port 80)
      - traefik.http.routers.lago-api.rule=Host(`billing-api.bizoholic.net`)
      - traefik.http.routers.lago-api.entrypoints=web
      # HTTPS Router (Port 443)
      - traefik.http.routers.lago-api-secure.rule=Host(`billing-api.bizoholic.net`)
      - traefik.http.routers.lago-api-secure.entrypoints=websecure
      - traefik.http.routers.lago-api-secure.tls.certresolver=letsencrypt
      - traefik.http.services.lago-api.loadbalancer.server.port=3000

  lago-front:
    image: getlago/front:v1.17.0
    container_name: lago-front
    environment:
      - LAGO_API_URL=https://billing-api.bizoholic.net
      - API_URL=https://billing-api.bizoholic.net
      - APP_ENV=production
    networks:
      - dokploy-network
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          cpus: "0.1"
          memory: 128M
    labels:
      - traefik.enable=true
      - traefik.docker.network=dokploy-network
      # HTTP Router (Port 80)
      - traefik.http.routers.lago-front.rule=Host(`billing.bizoholic.net`)
      - traefik.http.routers.lago-front.entrypoints=web
      # HTTPS Router (Port 443)
      - traefik.http.routers.lago-front-secure.rule=Host(`billing.bizoholic.net`)
      - traefik.http.routers.lago-front-secure.entrypoints=websecure
      - traefik.http.routers.lago-front-secure.tls.certresolver=letsencrypt
      - traefik.http.services.lago-front.loadbalancer.server.port=80

  lago-worker:
    image: getlago/api:v1.17.0
    container_name: lago-worker
    command: >
      /bin/sh -c "mkdir -p /app/keys && ruby -rbase64 -e 'File.write(\"/app/keys/private.pem\", Base64.decode64(ENV[\"LAGO_RSA_PRIVATE_KEY\"])); File.write(\"/app/keys/public.pem\", Base64.decode64(ENV[\"LAGO_RSA_PUBLIC_KEY\"]))' && echo \"RsaPrivateKey = OpenSSL::PKey::RSA.new(File.read('/app/keys/private.pem')); RsaPublicKey = RsaPrivateKey.public_key\" > config/initializers/rsa_keys.rb && ./scripts/start.worker.sh"
    environment:
      - DATABASE_URL=postgresql://neondb_owner:npg_puEbTnkSO9F8@ep-gentle-flower-a15rdh2r-pooler.ap-southeast-1.aws.neon.tech/neondb?sslmode=require
      - REDIS_URL=redis://default:Gt7QxXA4ybMzYzD9e6KIBULfnv1IU6f9@redis-10690.c264.ap-south-1-1.ec2.cloud.redislabs.com:10690/0
      - LAGO_REDIS_URL=redis://default:Gt7QxXA4ybMzYzD9e6KIBULfnv1IU6f9@redis-10690.c264.ap-south-1-1.ec2.cloud.redislabs.com:10690/0
      - LAGO_API_URL=https://billing-api.bizoholic.net
      - SECRET_KEY_BASE=85acd00b662a82aa2132d7639de8e6de655dcfe2d568abd05fbd069de0092dd4
      - ENCRYPTION_PRIMARY_KEY=2f9700e1e19ffbf8f970fa260e356c2b606ac09f2ee71ecd2a630936209337fb
      - ENCRYPTION_DETERMINISTIC_KEY=92ae2adaeb2093deb1e41a61ccb9b6f4fe5ec94b6b373f74c976b6b199c4efa6
      - ENCRYPTION_KEY_DERIVATION_SALT=135f8017cd510bbea948b0b06109c2d479f6b3f3fcb3e4d4181bf478715b85ba
      - RAILS_ENV=production
      - RAILS_LOG_TO_STDOUT=true
      - LAGO_RSA_PRIVATE_KEY=LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2UUlCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktjd2dnU2pBZ0VBQW9JQkFRQ3A0T0pXR2lSN0VqdWMKMURxVmFRV3RNcHFpU3hydDVHRUcxS3VGV1dwcDdJRVhMTzZ3WXQ0VkJvYmhaU09aYWkvbnVwVldYL1FxZmMwWgp1WHN0a2EvZ1Job05SY0xQSE5hZS9TWFpYZnc1MzQwbGE0NytXdFY3ckVNVHJ3THloSFlCbXpzN1hLa0ZiSi9nCnFnWDFRYi9mTWJGcGxpc0VPN3dzKzZhd0F0ZFI1L0hwYVdqdUR1NEg2TDBHRmViQjFXVWJHZGU5WmpIdkZIVTMKVVFCd0Znblk5YnhTcDdER0xzemxiSWh4cWhQZ2ErdE5vRHM0RjArcVE3OFRqWElvUWVudU1ST1ZTSHlhMjVWRQozR3J1LzRlOEh2SmRMUW5yWU0wRjh2YjRYRXU4WjkvWnRFRzVmYVlBMlMxNU5lWGpUdGd6NGN2WUZzZE5OV1lZCkVVUEVkQUFsQWdNQkFBRUNnZ0VBU1lGbXZqWHFvaHdtRWpxY3JNaTRMWlN2WjFrVEttdCs5a3N3ZW05UnhjcVIKb3ZzTXZ1TFEwSTAxOExKb0lIcGJoeXZyY1dmc2lUUk0rbndSQ2dzM2JGWTQ4SlJHY29LNmRTbjVaaUF1UXNaeAoxd2ErNVYxZGNYbDh2cmdrRU5iekRzZmg3ZEl1eW91UmRFOXRhNDJMSGVMdEx0Qk5CYlJwUEplWkxTRFZsWGtQCmM2RFp4ejF1UVg4V1J5ek1RdU5nMnh1MnpNNFBBMlFwOWNzcmJQWHpWcnhyTmwwcnFqcGJHRENibjVKZnQrSGoKRFcvdFdKWVJhKzlSOFN2OHhaYXh3SDdtQ08vOWxHbW1mRmRZUFB4UHIzempRQmpBeFhiRnExZzhyb0lqcXNVRgpnR2Rsd1BGbS9FL0NPRE5FZ0ZoTCs2STYwZGMvdVJEekRUWFhBaWxnQXdLQmdRRG5sOHhHRU9neFRBanpWcGJaCjRJS0JacWNLYTVkd0loWFh4VGdqdWdGTzVJN3g2cG80MERZOXNkbDlVeTFWN1ZRa1ZadnVoa25hTkN5cHM0bVcKc0Z4c3AxSTZEdFU1WmVjWXlaQVZPNFZBeVFtWXRCUUU4dWpaUkE5RUgvcDJNY0krRGdVWDV3bGtCemJDU29ZOQpMK3JNWjMvVmhPU3NvVmtxSmFZZk5reHpTd0tCZ1FDN3lCTmdQZDNXNXFsd2NnV3ZGUEFUWTRVYk5zZkIvYVNICnJqZy94ajNTT2VURVJRZjNUT3VHYjJ6dVBQcGVEQkVYeHNJR2hMY01PZ0prczFxYnhObzd2NUtWbGNMRXRXU2UKY1lwM2FvbnJvTkxEMjFZVlVDWVB5WGsxZU9tVzZ3RitqcDQwSDc4Nlh6bHA5L0ZsWjAyMWQ5WmErMld4R1l4cgpqcG4xT21YRVR3S0JnUURCYy9PV3M1akJWUnBFNmhlb2QvbUx6Z3ZLa0lVM2pjRmhNOFRwVXY2MHdBY0gzVWhtCkhNYXlVbFd5Y2tCMGZvTEN0eUJCNXJyYUlxc01Ob1MvOHlIQlFTTldpLzFnck5hVnhna3RNMExrRXdxSkhDTjgKM3N2U2NSK3ZjR2J2UkRGVlZMQzhmcWxCZlNVb3RzZmJaS05saXk4bFZKVVAvdGRVZFk2R2svelljUUtCZ0VpbgpuLytUMEZxT3dxNVVINmpmVkFoY2NDcllaaS9Ed0w0U2hZYi9YL29RRmxodVVTZTVKa1BNcHZ3Q3NlaGppTldIClBKa2pEbVAzcWVkbWtiOUZTaDdsLzRSSy9xSDNnU2Znekc5cDFGVkwwMkNlWTg4NVJKREZKbFd2SThvVndXMUQKSnlrSnc0YUZRNFNodjArNXlaSlYvS1VWTWdKMDNTVGNkdXN3SGlIM0FvR0FaTTFyS2hBbHB2aGcxbHdVTnoragpHY0srcGozOUlrY1EwT3Y5L1kxL1A1M3ZiODFKMXp6eFBIQ1VnM0V3cDFPQnZGV0NndldZenlHWUZ3WWtCQjRRCkZ1Q2VhVVhJbi80R0VBNTgwdkI2U1RMOVF5SzJhZ1FLKzErLzJVMk54cXczSXRHUGszbk00cnVraUhDcHdYNHyKQm9hckRxL2RkbGMrNDVHWFdhUzFaTEU9Ci0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS0K
      - LAGO_RSA_PUBLIC_KEY=LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUFxZURpVmhva2V4STduTlE2bFdrRgpyVEthb2tzYTdlUmhCdFNyaFZscWFleUJGeXp1c0dMZUZRYUc0V1VqbVdvdjU3cVZWbC8wS24zTkdibDdMWkd2CjRFWWFEVVhDenh6V252MGwyVjM4T2QrTkpXdU8vbHJWZTZ4REU2OEM4b1IyQVpzN08xeXBCV3lmNEtvRjlVRy8KM3pHeGFaWXJCRHU4TFB1bXNBTFhVZWZ4NldsbzdnN3VCK2k5QmhYbXdkVmxHeG5YdldZeDd4UjFOMUVBY0JZSgoyUFc4VXFld3hpN001V3lJY2FvVDRHdnJUYUE3T0JkUHFrTy9FNDF5S0VIcDdqRVRsVWg4bXR1VlJOeHE3ditICnZCN3lYUzBKNjJETkJmTDIrRnhMdkdmZjJiUkJ1WDJtQU5rdGVUWGw0MDdZTStITDJCYkhUVFZtR0JGRHhIUUEKSlFJREFRQUIKLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tCg==
      # OIDC / Authentik Configuration
      - OIDC_CLIENT_ID=bizosaas-portal
      - OIDC_CLIENT_SECRET=BizOSaaS2024!AuthentikSecret
      - OIDC_ISSUER_URL=https://auth-sso.bizoholic.net/application/o/bizosaas-platform/
      - OIDC_REDIRECT_URI=https://billing-api.bizoholic.net/auth/oidc/callback # Inferred, might be /auth/sso/callback

    volumes:
      - lago_keys_vol:/app/keys
    networks:
      - dokploy-network
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 1024M
        reservations:
          cpus: "0.25"
          memory: 512M

volumes:
  lago_keys_vol:


networks:
  dokploy-network:
    external: true
    name: dokploy-network
