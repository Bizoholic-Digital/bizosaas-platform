# BizOSaaS Platform - Enhanced Multi-Container Architecture with Vault Integration
# Dokploy Project: bizosaas-platform
# Dependencies: Requires bizosaas-infrastructure (including Vault) to be running first
# Updated: 2025-09-13 - Added Vault, unified tenant management, and Event Bus integration

services:
  # ========================================================================================
  # HASHICORP VAULT - Secrets Management (Infrastructure Layer)
  # ========================================================================================
  vault:
    image: hashicorp/vault:1.15.0
    container_name: bizosaas-vault
    ports:
      - "8200:8200"
    environment:
      - VAULT_DEV_ROOT_TOKEN_ID=bizosaas-vault-dev-token-2025
      - VAULT_DEV_LISTEN_ADDRESS=0.0.0.0:8200
      - VAULT_ADDR=http://0.0.0.0:8200
    cap_add:
      - IPC_LOCK
    volumes:
      - vault-data:/vault/data
      - vault-logs:/vault/logs
    networks:
      - dokploy-network
    restart: unless-stopped
    command: ["vault", "server", "-dev"]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.vault.rule=Host(`vault.bizoholic.com`)"
      - "traefik.http.services.vault.loadbalancer.server.port=8200"
      - "traefik.http.routers.vault.tls=true"
      - "traefik.http.routers.vault.tls.certresolver=letsencrypt"

  # ========================================================================================
  # CENTRAL BRAIN API - Enhanced FastAPI Service with Vault Integration
  # ========================================================================================
  bizosaas-brain:
    image: bizosaas/brain:latest
    container_name: bizosaas-brain
    ports:
      - "8001:8001"
    environment:
      # Vault Configuration (Primary secrets management)
      - VAULT_ADDR=http://vault:8200
      - VAULT_TOKEN=bizosaas-vault-dev-token-2025
      - VAULT_NAMESPACE=bizosaas
      
      # Database Configuration (External shared infrastructure)
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=postgres
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      
      # Redis Configuration (External shared infrastructure)
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_DB=0
      
      # Event Bus Configuration
      - EVENT_BUS_URL=http://event-bus:8009
      - EVENT_BUS_ENABLED=true
      - TENANT_ISOLATION_ENABLED=true
      
      # JWT & Security (Enhanced with Vault integration)
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - SERVICE_SECRET=${SERVICE_SECRET}
      
      # AI API Keys (Managed by Vault in production)
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      
      # Production Settings
      - NODE_ENV=production
      - DEBUG=false
      - LOG_LEVEL=info
      - BRAIN_API_VERSION=2.0.0
    networks:
      - dokploy-network
    depends_on:
      - vault
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.bizosaas-brain.rule=Host(`api.bizoholic.com`)"
      - "traefik.http.services.bizosaas-brain.loadbalancer.server.port=8001"
      - "traefik.http.routers.bizosaas-brain.tls=true"
      - "traefik.http.routers.bizosaas-brain.tls.certresolver=letsencrypt"

  # ========================================================================================
  # EVENT BUS - Advanced Tenant Isolation & Event Management
  # ========================================================================================
  event-bus:
    image: bizosaas/event-bus:latest
    container_name: bizosaas-event-bus
    ports:
      - "8009:8009"
    environment:
      # Event Bus Configuration
      - SERVICE_NAME=event-bus
      - SERVICE_PORT=8009
      - DEBUG=false
      
      # Database Configuration (Shared with Brain API)
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=postgres
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      
      # Redis Configuration (Message broker and caching)
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_DB=1
      
      # Vault Integration
      - VAULT_ADDR=http://vault:8200
      - VAULT_TOKEN=bizosaas-vault-dev-token-2025
      
      # Tenant Isolation Settings
      - ENABLE_TENANT_ISOLATION=true
      - MAX_RETRY_ATTEMPTS=3
      - RETRY_DELAY_SECONDS=5
      - EVENT_TTL_DAYS=30
      - BATCH_SIZE=100
      - WORKER_CONCURRENCY=10
      - METRICS_ENABLED=true
      - HEALTH_CHECK_INTERVAL=30
      
      # Security
      - JWT_SECRET=${JWT_SECRET_KEY}
      - ALLOWED_ORIGINS=https://api.bizoholic.com,https://admin.bizoholic.com
    networks:
      - dokploy-network
    depends_on:
      - vault
      - bizosaas-brain
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.event-bus.rule=Host(`events.bizoholic.com`)"
      - "traefik.http.services.event-bus.loadbalancer.server.port=8009"
      - "traefik.http.routers.event-bus.tls=true"
      - "traefik.http.routers.event-bus.tls.certresolver=letsencrypt"

  # ========================================================================================
  # DJANGO CRM - Customer Relationship Management
  # ========================================================================================
  django-crm:
    image: bizosaas/django-crm:latest
    container_name: bizosaas-django-crm
    ports:
      - "8003:8003"
    environment:
      # Django Configuration
      - DJANGO_SETTINGS_MODULE=crm_project.settings.production
      - SECRET_KEY=${DJANGO_SECRET_KEY}
      - DEBUG=False
      - ALLOWED_HOSTS=crm.bizoholic.com,api.bizoholic.com
      
      # Database Configuration
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@postgres:5432/postgres
      
      # Vault Integration
      - VAULT_ADDR=http://vault:8200
      - VAULT_TOKEN=bizosaas-vault-dev-token-2025
      
      # Brain API Integration
      - BRAIN_API_URL=http://bizosaas-brain:8001
      - BRAIN_API_TOKEN=${SERVICE_SECRET}
      
      # Event Bus Integration
      - EVENT_BUS_URL=http://event-bus:8009
      - ENABLE_EVENT_PUBLISHING=true
      
      # Cache Configuration
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/2
    networks:
      - dokploy-network
    depends_on:
      - vault
      - bizosaas-brain
      - event-bus
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.django-crm.rule=Host(`crm.bizoholic.com`)"
      - "traefik.http.services.django-crm.loadbalancer.server.port=8003"
      - "traefik.http.routers.django-crm.tls=true"
      - "traefik.http.routers.django-crm.tls.certresolver=letsencrypt"

  # ========================================================================================
  # WAGTAIL CMS - Content Management System
  # ========================================================================================
  wagtail-cms:
    image: bizosaas/wagtail-cms:latest
    container_name: bizosaas-wagtail-cms
    ports:
      - "4000:4000"
    environment:
      # Django/Wagtail Configuration
      - DJANGO_SETTINGS_MODULE=wagtail_cms.settings.production
      - SECRET_KEY=${WAGTAIL_SECRET_KEY}
      - DEBUG=False
      - ALLOWED_HOSTS=cms.bizoholic.com,api.bizoholic.com
      
      # Database Configuration
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@postgres:5432/postgres
      
      # Vault Integration
      - VAULT_ADDR=http://vault:8200
      - VAULT_TOKEN=bizosaas-vault-dev-token-2025
      
      # Brain API Integration
      - BRAIN_API_URL=http://bizosaas-brain:8001
      - BRAIN_API_TOKEN=${SERVICE_SECRET}
      
      # Cache Configuration
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/3
      
      # Static Files (for production)
      - STATIC_URL=/static/
      - MEDIA_URL=/media/
    volumes:
      - wagtail-static:/app/staticfiles
      - wagtail-media:/app/media
    networks:
      - dokploy-network
    depends_on:
      - vault
      - bizosaas-brain
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.wagtail-cms.rule=Host(`cms.bizoholic.com`)"
      - "traefik.http.services.wagtail-cms.loadbalancer.server.port=4000"
      - "traefik.http.routers.wagtail-cms.tls=true"
      - "traefik.http.routers.wagtail-cms.tls.certresolver=letsencrypt"

  # ========================================================================================
  # AI AGENTS - CrewAI Multi-Agent System
  # ========================================================================================
  ai-agents:
    image: bizosaas/ai-agents:latest
    container_name: bizosaas-ai-agents
    ports:
      - "8000:8000"
    environment:
      # AI Configuration
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      
      # Vault Integration (for AI API key rotation)
      - VAULT_ADDR=http://vault:8200
      - VAULT_TOKEN=bizosaas-vault-dev-token-2025
      
      # Brain API Integration
      - BRAIN_API_URL=http://bizosaas-brain:8001
      - BRAIN_API_TOKEN=${SERVICE_SECRET}
      
      # Event Bus Integration (for AI agent events)
      - EVENT_BUS_URL=http://event-bus:8009
      - PUBLISH_AGENT_EVENTS=true
      
      # Database Configuration (for agent state persistence)
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@postgres:5432/postgres
      
      # CrewAI Configuration
      - CREWAI_TELEMETRY_OPT_OUT=true
      - AGENT_TIMEOUT=300
      - MAX_CONCURRENT_AGENTS=5
    networks:
      - dokploy-network
    depends_on:
      - vault
      - bizosaas-brain
      - event-bus
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ai-agents.rule=Host(`agents.bizoholic.com`)"
      - "traefik.http.services.ai-agents.loadbalancer.server.port=8000"
      - "traefik.http.routers.ai-agents.tls=true"
      - "traefik.http.routers.ai-agents.tls.certresolver=letsencrypt"

  # ========================================================================================
  # UNIFIED DASHBOARD - Enhanced Admin Interface
  # ========================================================================================
  unified-dashboard:
    image: bizosaas/dashboard:latest
    container_name: unified-dashboard
    ports:
      - "5004:5004"
    environment:
      # Brain API Integration
      - BRAIN_API_URL=http://bizosaas-brain:8001
      - BRAIN_API_BASE_URL=https://api.bizoholic.com
      - BRAIN_API_TOKEN=${SERVICE_SECRET}
      
      # Vault Integration (for dashboard secrets)
      - VAULT_ADDR=http://vault:8200
      - VAULT_TOKEN=bizosaas-vault-dev-token-2025
      
      # Event Bus Integration (for real-time updates)
      - EVENT_BUS_URL=http://event-bus:8009
      - ENABLE_REAL_TIME_UPDATES=true
      
      # Cache Configuration
      - REDIS_HOST=redis
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_DB=4
      
      # Dashboard Features
      - ENABLE_TENANT_MANAGEMENT=true
      - ENABLE_EVENT_MONITORING=true
      - ENABLE_AI_AGENT_CONTROL=true
      - DASHBOARD_VERSION=2.0.0
    networks:
      - dokploy-network
    depends_on:
      - vault
      - bizosaas-brain
      - event-bus
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.unified-dashboard.rule=Host(`admin.bizoholic.com`)"
      - "traefik.http.services.unified-dashboard.loadbalancer.server.port=5004"
      - "traefik.http.routers.unified-dashboard.tls=true"
      - "traefik.http.routers.unified-dashboard.tls.certresolver=letsencrypt"

  # ========================================================================================
  # TELEGRAM INTEGRATION - 5 Active Bots
  # ========================================================================================
  telegram-integration:
    image: bizosaas/telegram:latest
    container_name: telegram-integration
    ports:
      - "4006:4006"
    environment:
      # Telegram Bot Tokens (Real credentials from ~/projects/credentials.md)
      - TELEGRAM_JONNYAI_BOT_TOKEN=${TELEGRAM_JONNYAI_BOT_TOKEN}
      - TELEGRAM_BIZOHOLIC_BOT_TOKEN=${TELEGRAM_BIZOHOLIC_BOT_TOKEN}
      - TELEGRAM_DEALS4ALL_BOT_TOKEN=${TELEGRAM_DEALS4ALL_BOT_TOKEN}
      - TELEGRAM_BOTTRADER_BOT_TOKEN=${TELEGRAM_BOTTRADER_BOT_TOKEN}
      - TELEGRAM_GOGOFATHER_BOT_TOKEN=${TELEGRAM_GOGOFATHER_BOT_TOKEN}
      - BRAIN_API_URL=http://bizosaas-brain:8001
    networks:
      - dokploy-network
    depends_on:
      - bizosaas-brain
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.telegram-integration.rule=Host(`bots.bizoholic.com`)"
      - "traefik.http.services.telegram-integration.loadbalancer.server.port=4006"
      - "traefik.http.routers.telegram-integration.tls=true"
      - "traefik.http.routers.telegram-integration.tls.certresolver=letsencrypt"

  # ========================================================================================
  # IMAGE INTEGRATION - Multi-API Image Service
  # ========================================================================================
  image-integration:
    image: bizosaas/images:latest
    container_name: image-integration
    ports:
      - "4007:4007"
    environment:
      # Image API Keys (ready for real credentials)
      - PEXELS_API_KEY=${PEXELS_API_KEY:-}
      - UNSPLASH_ACCESS_KEY=${UNSPLASH_ACCESS_KEY:-}
      - PIXABAY_API_KEY=${PIXABAY_API_KEY:-}
      
      # Amazon SP-API (for product images)
      - AMAZON_ACCESS_KEY=${AMAZON_ACCESS_KEY:-}
      - AMAZON_SECRET_KEY=${AMAZON_SECRET_KEY:-}
      - AMAZON_PARTNER_TAG=${AMAZON_PARTNER_TAG:-}
      
      - BRAIN_API_URL=http://bizosaas-brain:8001
    networks:
      - dokploy-network
    depends_on:
      - bizosaas-brain
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.image-integration.rule=Host(`images.bizoholic.com`)"
      - "traefik.http.services.image-integration.loadbalancer.server.port=4007"
      - "traefik.http.routers.image-integration.tls=true"
      - "traefik.http.routers.image-integration.tls.certresolver=letsencrypt"

  # ========================================================================================
  # TEMPORAL WORKFLOWS - Python workflow orchestration (replacing n8n)
  # ========================================================================================
  temporal-workflows:
    image: bizosaas/temporal:latest
    container_name: temporal-workflows
    ports:
      - "8202:8202"
    environment:
      - TEMPORAL_HOST=localhost
      - TEMPORAL_PORT=7233
      - TEMPORAL_NAMESPACE=bizosaas
      - BRAIN_API_URL=http://bizosaas-brain:8001
      - POSTGRES_HOST=postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    networks:
      - dokploy-network
    depends_on:
      - bizosaas-brain
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.temporal-workflows.rule=Host(`automation.bizoholic.com`)"
      - "traefik.http.services.temporal-workflows.loadbalancer.server.port=8202"
      - "traefik.http.routers.temporal-workflows.tls=true"
      - "traefik.http.routers.temporal-workflows.tls.certresolver=letsencrypt"

# ========================================================================================
# VOLUMES - Persistent Data Storage
# ========================================================================================
volumes:
  # Vault persistent storage
  vault-data:
    driver: local
  vault-logs:
    driver: local
  
  # CMS static and media files
  wagtail-static:
    driver: local
  wagtail-media:
    driver: local
  
  # Event Bus logs and cache
  event-bus-logs:
    driver: local

# ========================================================================================
# NETWORKS (External - created by Dokploy)
# ========================================================================================
networks:
  dokploy-network:
    external: true