# AlertManager configuration for BizOSaaS Platform
global:
  smtp_smarthost: 'localhost:587'
  smtp_from: 'alerts@bizosaas.com'
  smtp_auth_username: ''
  smtp_auth_password: ''
  slack_api_url: '${SLACK_WEBHOOK_URL}'
  resolve_timeout: 5m

# Templates for custom alert formatting
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Routing configuration
route:
  group_by: ['alertname', 'severity', 'category']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'default-receiver'
  
  routes:
  # Critical alerts - immediate notification
  - match:
      severity: critical
    receiver: 'critical-alerts'
    group_wait: 0s
    repeat_interval: 5m
    routes:
    - match:
        category: bizosaas
      receiver: 'critical-bizosaas'
    - match:
        category: infrastructure
      receiver: 'critical-infrastructure'
    - match:
        category: security
      receiver: 'security-alerts'

  # Warning alerts - grouped notifications
  - match:
      severity: warning
    receiver: 'warning-alerts'
    group_wait: 30s
    repeat_interval: 30m
    routes:
    - match:
        category: business
      receiver: 'business-alerts'
    - match:
        category: application
      receiver: 'application-alerts'

  # Info alerts - daily digest
  - match:
      severity: info
    receiver: 'info-alerts'
    group_wait: 5m
    repeat_interval: 12h

  # Maintenance/silenced alerts
  - match:
      alertname: 'MaintenanceMode'
    receiver: 'null'

# Notification receivers
receivers:
- name: 'default-receiver'
  webhook_configs:
  - url: 'http://bizosaas-monitoring-dashboard:3000/api/alerts/webhook'
    send_resolved: true
    http_config:
      bearer_token: 'your-webhook-token-here'

- name: 'critical-alerts'
  email_configs:
  - to: 'oncall@bizosaas.com'
    subject: 'üö® CRITICAL: {{ .GroupLabels.alertname }} - BizOSaaS Platform'
    body: |
      {{ range .Alerts }}
      **Alert:** {{ .Annotations.summary }}
      **Description:** {{ .Annotations.description }}
      **Severity:** {{ .Labels.severity }}
      **Service:** {{ .Labels.job }}
      **Started:** {{ .StartsAt.Format "2006-01-02 15:04:05 UTC" }}
      
      {{ if .Labels.runbook_url }}**Runbook:** {{ .Labels.runbook_url }}{{ end }}
      {{ end }}
      
      **Dashboard:** http://localhost:3100/d/bizosaas-overview
      **Alertmanager:** http://localhost:9093
    html: |
      <h2 style="color: #dc2626;">üö® Critical Alert - BizOSaaS Platform</h2>
      {{ range .Alerts }}
      <div style="border: 1px solid #dc2626; padding: 10px; margin: 10px 0; background: #fef2f2;">
        <h3>{{ .Annotations.summary }}</h3>
        <p><strong>Description:</strong> {{ .Annotations.description }}</p>
        <p><strong>Severity:</strong> <span style="color: #dc2626;">{{ .Labels.severity }}</span></p>
        <p><strong>Service:</strong> {{ .Labels.job }}</p>
        <p><strong>Started:</strong> {{ .StartsAt.Format "2006-01-02 15:04:05 UTC" }}</p>
        {{ if .Labels.runbook_url }}<p><a href="{{ .Labels.runbook_url }}">üîß Runbook</a></p>{{ end }}
      </div>
      {{ end }}
  
  slack_configs:
  - channel: '#critical-alerts'
    title: 'üö® Critical BizOSaaS Alert'
    text: |
      {{ range .Alerts }}
      *Alert:* {{ .Annotations.summary }}
      *Description:* {{ .Annotations.description }}
      *Service:* {{ .Labels.job }}
      *Severity:* {{ .Labels.severity }}
      {{ if .Labels.runbook_url }}*Runbook:* {{ .Labels.runbook_url }}{{ end }}
      {{ end }}
    color: 'danger'
    send_resolved: true

  webhook_configs:
  - url: 'http://bizosaas-monitoring-dashboard:3000/api/alerts/critical'
    send_resolved: true

- name: 'critical-bizosaas'
  email_configs:
  - to: 'platform-team@bizosaas.com'
    subject: 'üö® CRITICAL BizOSaaS Service Alert: {{ .GroupLabels.alertname }}'
    body: |
      **CRITICAL PLATFORM ALERT**
      
      {{ range .Alerts }}
      Service: {{ .Labels.job }}
      Issue: {{ .Annotations.summary }}
      Details: {{ .Annotations.description }}
      Started: {{ .StartsAt.Format "2006-01-02 15:04:05 UTC" }}
      {{ end }}
      
      **Immediate Action Required**
      - Check service health: http://localhost:3100/d/bizosaas-services
      - Review logs: http://localhost:5601
      - Platform status: http://localhost:3102
  
  slack_configs:
  - channel: '#platform-alerts'
    title: 'üö® Critical BizOSaaS Platform Issue'
    color: 'danger'

- name: 'critical-infrastructure'
  email_configs:
  - to: 'infrastructure@bizosaas.com'
    subject: 'üèóÔ∏è CRITICAL Infrastructure Alert: {{ .GroupLabels.alertname }}'
  
  slack_configs:
  - channel: '#infrastructure-alerts'
    title: 'üèóÔ∏è Critical Infrastructure Alert'
    color: 'danger'

- name: 'security-alerts'
  email_configs:
  - to: 'security@bizosaas.com'
    subject: 'üîí SECURITY Alert: {{ .GroupLabels.alertname }}'
    body: |
      **SECURITY ALERT DETECTED**
      
      {{ range .Alerts }}
      Alert: {{ .Annotations.summary }}
      Description: {{ .Annotations.description }}
      Service: {{ .Labels.job }}
      Time: {{ .StartsAt.Format "2006-01-02 15:04:05 UTC" }}
      {{ end }}
      
      **Security Dashboard:** http://localhost:3102/security
      **Investigate immediately and document response**
  
  slack_configs:
  - channel: '#security-alerts'
    title: 'üîí Security Alert - BizOSaaS Platform'
    color: 'danger'

- name: 'warning-alerts'
  slack_configs:
  - channel: '#alerts'
    title: '‚ö†Ô∏è Warning Alert - BizOSaaS'
    text: |
      {{ range .Alerts }}
      *Service:* {{ .Labels.job }}
      *Alert:* {{ .Annotations.summary }}
      *Description:* {{ .Annotations.description }}
      {{ end }}
    color: 'warning'
    send_resolved: true

- name: 'business-alerts'
  email_configs:
  - to: 'business-ops@bizosaas.com'
    subject: 'üìä Business Metric Alert: {{ .GroupLabels.alertname }}'
  
  slack_configs:
  - channel: '#business-ops'
    title: 'üìä Business Metric Alert'
    color: 'warning'

- name: 'application-alerts'
  slack_configs:
  - channel: '#dev-alerts'
    title: 'üíª Application Alert'
    color: 'warning'

- name: 'info-alerts'
  email_configs:
  - to: 'monitoring@bizosaas.com'
    subject: '‚ÑπÔ∏è BizOSaaS Platform Info: {{ .GroupLabels.alertname }}'

- name: 'null'
  # Silenced alerts go here

# Inhibition rules to prevent alert spam
inhibit_rules:
# Stop warning alerts when critical alerts are firing for the same service
- source_match:
    severity: 'critical'
  target_match:
    severity: 'warning'
  equal: ['alertname', 'job', 'instance']

# Stop application alerts when service is down
- source_match:
    alertname: 'ServiceDown'
  target_match_re:
    alertname: '(HighErrorRate|SlowResponseTime).*'
  equal: ['job', 'instance']

# Stop infrastructure alerts when node is down
- source_match:
    alertname: 'ServiceDown'
    job: 'node-exporter'
  target_match_re:
    alertname: '(HighCPUUsage|HighMemoryUsage|DiskSpace).*'
  equal: ['instance']

# Stop container alerts when container orchestrator alerts are firing
- source_match:
    category: 'infrastructure'
    severity: 'critical'
  target_match:
    category: 'containers'
  equal: ['instance']