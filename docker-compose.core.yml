# ═══════════════════════════════════════════════════════════════════════════
# BizOSaaS Core Services Stack
# ═══════════════════════════════════════════════════════════════════════════
# Contains: API Gateway, Auth Service, MCP Servers
# Deploy this AFTER infrastructure stack
# ═══════════════════════════════════════════════════════════════════════════

services:
  # ========================================
  # API Gateway
  # ========================================
  brain-gateway:
    image: ghcr.io/bizoholic-digital/bizosaas-platform/brain-gateway:staging
    build:
      context: ./bizosaas-brain-core/brain-gateway
      dockerfile: Dockerfile
    # container_name: bizosaas-brain-staging
    environment:
      # Database & Cache
      - DATABASE_URL=postgresql://admin:BizOSaaS2025%21StagingDB@bizosaas-postgres-staging:5432/bizosaas_staging
      - REDIS_URL=redis://bizosaas-redis-staging:6379/0

      # Authentication
      - JWT_SECRET=${JWT_SECRET:-vdMxrD6bZpZk6lClpkSP56+WNapkPAG5lY+BojEA/u7ffehUKcVL7re6xRaPWUCZffoxXF9ZFuU+KcZSWpz6CA==}

      # Temporal
      - TEMPORAL_HOST=bizosaas-temporal-server-staging:7233

      # LLM API Keys (use environment variables for security)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      - COHERE_API_KEY=${COHERE_API_KEY:-}
      - MISTRAL_API_KEY=${MISTRAL_API_KEY:-}
      - GROQ_API_KEY=${GROQ_API_KEY:-}
      - TOGETHER_API_KEY=${TOGETHER_API_KEY:-}
      - PERPLEXITY_API_KEY=${PERPLEXITY_API_KEY:-}

      # GitHub Integration
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}

      # Server Configuration
      - ALLOWED_HOSTS=api.bizoholic.net,localhost
      - CORS_ALLOWED_ORIGINS=https://app.bizoholic.net,https://admin.bizoholic.net

    networks:
      - brain-network
      - dokploy-network

    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.brain-gateway.rule=Host(`api.bizoholic.net`)"
      - "traefik.http.routers.brain-gateway.entrypoints=websecure"
      - "traefik.http.routers.brain-gateway.tls.certresolver=letsencrypt"
      - "traefik.http.services.brain-gateway.loadbalancer.server.port=8000"
      - "traefik.docker.network=dokploy-network"

    healthcheck:
      test: [ "CMD-SHELL", "python -c 'import urllib.request; urllib.request.urlopen(\"http://localhost:8000/health\")'" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    restart: unless-stopped
  # ========================================
  # MCP Server (GitHub Integration)
  # ========================================
  # Commented out - image not available
  # github-mcp:
  #   image: ghcr.io/modelcontextprotocol/servers/github:latest
  #   container_name: brain-mcp-github
  #   environment:
  #     - GITHUB_PERSONAL_ACCESS_TOKEN=${GITHUB_TOKEN:-}
  #   networks:
  #     - brain-network
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '0.2'
  #         memory: 256M
  #   restart: unless-stopped

  # ═══════════════════════════════════════════════════════════════════════════
  # Networks
  # ═══════════════════════════════════════════════════════════════════════════
networks:
  brain-network:
    driver: bridge
    name: brain-network
  dokploy-network:
    external: true
