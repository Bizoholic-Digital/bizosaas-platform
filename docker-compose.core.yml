# ═══════════════════════════════════════════════════════════════════════════
# BizOSaaS Core Services Stack
# ═══════════════════════════════════════════════════════════════════════════
# Contains: API Gateway, Auth Service, MCP Servers
# Deploy this AFTER infrastructure stack
# ═══════════════════════════════════════════════════════════════════════════

services:
  # ========================================
  # API Gateway
  # ========================================
  brain-gateway:
    image: ghcr.io/bizoholic-digital/bizosaas-platform/brain-gateway:staging
    build:
      context: ./bizosaas-brain-core/brain-gateway
      dockerfile: Dockerfile
    container_name: brain-gateway
    environment:
      - DATABASE_URL=postgresql://admin:QWyfkmjcfbpYnMDkxqzAOJBcPvlZCtkh8R/+DTz+SkA=@bizosaas-postgres-staging:5432/bizosaas_staging
      - REDIS_URL=redis://bizosaas-redis-staging:6379/0
      - TEMPORAL_HOST=bizosaas-temporal-server-staging:7233
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
    networks:
      - brain-network
      - dokploy-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.brain-gateway.rule=Host(`api.bizoholic.net`)"
      - "traefik.http.routers.brain-gateway.entrypoints=websecure"
      - "traefik.http.routers.brain-gateway.tls.certresolver=letsencrypt"
      - "traefik.http.services.brain-gateway.loadbalancer.server.port=8000"
    restart: unless-stopped

  # ========================================
  # Auth Service
  # ========================================
  auth-service:
    image: ghcr.io/bizoholic-digital/bizosaas-platform/auth-service:staging
    build:
      context: ./bizosaas-brain-core/auth-service
      dockerfile: Dockerfile
    container_name: brain-auth
    environment:
      # Use existing Dokploy-managed postgres
      - DATABASE_URL=postgresql+asyncpg://admin:QWyfkmjcfbpYnMDkxqzAOJBcPvlZCtkh8R/+DTz+SkA=@bizosaas-postgres-staging:5432/bizosaas_staging
      - REDIS_URL=redis://bizosaas-redis-staging:6379/1
      - JWT_SECRET=${JWT_SECRET:-super-secret-key}
    networks:
      - brain-network
      - dokploy-network
    deploy:
      resources:
        limits:
          cpus: '0.3'
          memory: 256M
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.brain-auth.rule=Host(`auth-api.bizoholic.net`)"
      - "traefik.http.routers.brain-auth.entrypoints=websecure"
      - "traefik.http.routers.brain-auth.tls.certresolver=letsencrypt"
      - "traefik.http.services.brain-auth.loadbalancer.server.port=8007"
    restart: unless-stopped
  # ========================================
  # MCP Server (GitHub Integration)
  # ========================================
  # Commented out - image not available
  # github-mcp:
  #   image: ghcr.io/modelcontextprotocol/servers/github:latest
  #   container_name: brain-mcp-github
  #   environment:
  #     - GITHUB_PERSONAL_ACCESS_TOKEN=${GITHUB_TOKEN:-}
  #   networks:
  #     - brain-network
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '0.2'
  #         memory: 256M
  #   restart: unless-stopped

  # ═══════════════════════════════════════════════════════════════════════════
  # Networks
  # ═══════════════════════════════════════════════════════════════════════════
networks:
  brain-network:
    external: true
  dokploy-network:
    external: true
