# ═══════════════════════════════════════════════════════════════════════════
# BizOSaaS Core Services Stack
# ═══════════════════════════════════════════════════════════════════════════
# Contains: Infrastructure (Embedded), API Gateway, MCP Servers
# ═══════════════════════════════════════════════════════════════════════════

services:
  # ========================================
  # Infrastructure (Embedded for Stability)
  # ========================================
  postgres:
    image: ankane/pgvector:v0.5.1
    container_name: brain-postgres
    environment:
      POSTGRES_DB: bizosaas
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
    networks:
      brain-network:
        aliases:
          - postgres
          - db
    deploy:
      resources:
        limits:
          memory: 512M
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: brain-redis
    networks:
      brain-network:
        aliases:
          - redis
          - cache
    deploy:
      resources:
        limits:
          memory: 256M
    restart: unless-stopped

  vault:
    image: hashicorp/vault:latest
    container_name: brain-vault
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: ${VAULT_TOKEN:-staging-root-token-bizosaas-2025}
      VAULT_DEV_LISTEN_ADDRESS: "0.0.0.0:8200"
    networks:
      brain-network:
        aliases:
          - vault
          - brain-vault
    cap_add:
      - IPC_LOCK
    deploy:
      resources:
        limits:
          memory: 128M
    restart: unless-stopped

  # ========================================
  # API Gateway
  # ========================================
  brain-gateway:
    image: ghcr.io/bizoholic-digital/bizosaas-platform/brain-gateway:staging
    build:
      context: ./bizosaas-brain-core/brain-gateway
      dockerfile: Dockerfile
    container_name: bizosaas-brain-staging
    expose:
      - "8000"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - VECTOR_DB_URL=${VECTOR_DB_URL}
      - REDIS_URL=${REDIS_URL}
      - JWT_SECRET=${JWT_SECRET}
      - TEMPORAL_HOST=${TEMPORAL_HOST}
      - TEMPORAL_NAMESPACE=${TEMPORAL_NAMESPACE}
      - USE_VAULT=true
      - VAULT_ADDR=http://brain-vault:8200
      - VAULT_TOKEN=${VAULT_TOKEN}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-https://app.bizoholic.net,https://admin.bizoholic.net,https://bizoholic.net}
    networks:
      - brain-network
      - dokploy-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=dokploy-network"
      - "traefik.http.routers.brain-gateway.rule=Host(`${BRAIN_GATEWAY_DOMAIN:-api.bizoholic.net}`)"
      - "traefik.http.routers.brain-gateway.tls=true"
      - "traefik.http.routers.brain-gateway.tls.certresolver=letsencrypt"
      - "traefik.http.services.brain-gateway.loadbalancer.server.port=8000"
    restart: unless-stopped

  # ========================================
  # MCP Servers (Internal Stdio)
  # ========================================
  fluentcrm-mcp:
    image: ghcr.io/bizoholic-digital/bizosaas-platform/fluentcrm-mcp:staging
    build:
      context: ./mcp-servers/fluent-crm
      dockerfile: Dockerfile
    container_name: brain-mcp-fluentcrm
    environment:
      - FLUENTCRM_WP_URL=${FLUENTCRM_WP_URL:-}
      - FLUENTCRM_WP_USER=${FLUENTCRM_WP_USER:-}
      - FLUENTCRM_WP_APP_PASSWORD=${FLUENTCRM_WP_APP_PASSWORD:-}
    networks:
      - brain-network
    stdin_open: true
    tty: true
    restart: unless-stopped

  brave-search-mcp:
    image: ghcr.io/bizoholic-digital/bizosaas-platform/brave-search-mcp:staging
    build:
      context: ./mcp-servers/brave-search
      dockerfile: Dockerfile
    container_name: brain-mcp-brave-search
    environment:
      - BRAVE_API_KEY=${BRAVE_API_KEY:-}
    networks:
      - brain-network
    stdin_open: true
    tty: true
    restart: unless-stopped

  filesystem-mcp:
    image: ghcr.io/bizoholic-digital/bizosaas-platform/filesystem-mcp:staging
    build:
      context: ./mcp-servers/filesystem
      dockerfile: Dockerfile
    container_name: brain-mcp-filesystem
    environment:
      - FILESYSTEM_ROOT=/data
    volumes:
      - bizosaas-data:/data
    networks:
      - brain-network
    stdin_open: true
    tty: true
    restart: unless-stopped

  google-drive-mcp:
    image: ghcr.io/bizoholic-digital/bizosaas-platform/google-drive-mcp:staging
    build:
      context: ./mcp-servers/google-drive
      dockerfile: Dockerfile
    container_name: brain-mcp-google-drive
    environment:
      - GOOGLE_SERVICE_ACCOUNT_JSON=${GOOGLE_SERVICE_ACCOUNT_JSON:-}
    networks:
      - brain-network
    stdin_open: true
    tty: true
    restart: unless-stopped

  github-mcp:
    image: ghcr.io/bizoholic-digital/bizosaas-platform/github-mcp:staging
    build:
      context: ./mcp-servers/github
      dockerfile: Dockerfile
    container_name: brain-mcp-github
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
    networks:
      - brain-network
    stdin_open: true
    tty: true
    restart: unless-stopped

  slack-mcp:
    image: ghcr.io/bizoholic-digital/bizosaas-platform/slack-mcp:staging
    build:
      context: ./mcp-servers/slack
      dockerfile: Dockerfile
    container_name: brain-mcp-slack
    environment:
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN:-}
    networks:
      - brain-network
    stdin_open: true
    tty: true
    restart: unless-stopped

  business-directory:
    image: ghcr.io/bizoholic-digital/business-directory:staging
    build:
      context: ./portals/business-directory/business-directory
      dockerfile: Dockerfile
    container_name: bizosaas-directory-staging
    expose:
      - "3004"
    environment:
      - NEXT_PUBLIC_API_BASE_URL=${NEXT_PUBLIC_API_BASE_URL:-https://api.bizoholic.net}
      - NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=${GOOGLE_MAPS_API_KEY}
    networks:
      - brain-network
      - dokploy-network
    deploy:
      resources:
        limits:
          memory: 512M
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=dokploy-network"
      - "traefik.http.routers.business-directory.rule=Host(`directory.bizoholic.net`) || HostRegexp(`{subdomain:[a-z0-9-]+}.bizoholic.net`)"
      - "traefik.http.routers.business-directory.tls=true"
      - "traefik.http.routers.business-directory.tls.certresolver=letsencrypt"
      - "traefik.http.routers.business-directory.priority=1"
      - "traefik.http.services.business-directory.loadbalancer.server.port=3004"
    restart: unless-stopped

networks:
  brain-network:
    external: true
    name: brain-network
  dokploy-network:
    external: true

volumes:
  bizosaas-data:
    name: bizosaas-data
