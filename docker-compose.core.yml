# ═══════════════════════════════════════════════════════════════════════════
# BizOSaaS Core Services Stack
# ═══════════════════════════════════════════════════════════════════════════
# Contains: API Gateway, Auth Service, MCP Servers
# Deploy this AFTER infrastructure stack
# ═══════════════════════════════════════════════════════════════════════════

services:
  # ========================================
  # API Gateway
  # ========================================
  brain-gateway:
    image: ghcr.io/bizoholic-digital/bizosaas-platform/brain-gateway:staging
    build:
      context: ./bizosaas-brain-core/brain-gateway
      dockerfile: Dockerfile
    # Ports managed by Traefik - no host binding needed
    container_name: bizosaas-brain-staging
    expose:
      - "8000"
    environment:
      # Database & Cache (Mapping to Dokploy Env)
      - DATABASE_URL=${DATABASE_URL:-postgresql://postgres:postgres@postgres:5432/bizosaas}
      - VECTOR_DB_URL=${VECTOR_DB_URL:-http://qdrant:6333}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}

      # Authentication
      - JWT_SECRET=${JWT_SECRET:-BizOSaaS2025!JWTSecret}

      # Temporal (Temporal Cloud)
      - TEMPORAL_HOST=${TEMPORAL_HOST:-temporal:7233}
      - TEMPORAL_NAMESPACE=${TEMPORAL_NAMESPACE:-default}

      # Vault (Internal)
      - USE_VAULT=true
      - VAULT_ADDR=http://vault:8200
      - VAULT_TOKEN=${VAULT_TOKEN:-root}

      # Plans.so Cloud settings
      - PLANE_WEBHOOK_SECRET=${PLANE_WEBHOOK_SECRET:-}
      - PLANE_WEBHOOK_URL=${PLANE_WEBHOOK_URL:-}

      # LLM API Keys
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}

      # Server Configuration
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-api.bizoholic.net,localhost}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-https://app.bizoholic.net,https://admin.bizoholic.net}

    networks:
      - brain-network
      - dokploy-network

    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M

    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=dokploy-network"
      # HTTP Router (redirect to HTTPS)
      - "traefik.http.routers.brain-gateway-http.rule=Host(`${BRAIN_GATEWAY_DOMAIN:-api.bizoholic.net}`)"
      - "traefik.http.routers.brain-gateway-http.entrypoints=web"
      - "traefik.http.routers.brain-gateway-http.middlewares=redirect-to-https"
      # HTTPS Router
      - "traefik.http.routers.brain-gateway.rule=Host(`${BRAIN_GATEWAY_DOMAIN:-api.bizoholic.net}`)"
      - "traefik.http.routers.brain-gateway.entrypoints=websecure"
      - "traefik.http.routers.brain-gateway.tls=true"
      - "traefik.http.routers.brain-gateway.tls.certresolver=letsencrypt"
      # Service
      - "traefik.http.services.brain-gateway.loadbalancer.server.port=8000"
      # Middleware for HTTPS redirect
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"

    healthcheck:
      test: [ "CMD-SHELL", "python -c 'import urllib.request; urllib.request.urlopen(\"http://localhost:8000/health\")'" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    restart: unless-stopped
  # ========================================
  # MCP Server (FluentCRM Integration)
  # ========================================
  fluentcrm-mcp:
    image: ghcr.io/bizoholic-digital/bizosaas-platform/fluentcrm-mcp:staging
    build:
      context: ./mcp-servers/fluent-crm
      dockerfile: Dockerfile
    container_name: brain-mcp-fluentcrm
    environment:
      - FLUENTCRM_WP_URL=${FLUENTCRM_WP_URL:-}
      - FLUENTCRM_WP_USER=${FLUENTCRM_WP_USER:-}
      - FLUENTCRM_WP_APP_PASSWORD=${FLUENTCRM_WP_APP_PASSWORD:-}
    networks:
      - brain-network
    stdin_open: true
    tty: true
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 256M
    healthcheck:
      test: [ "CMD", "python3", "-c", "import sys; sys.exit(0)" ]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  # ========================================
  # MCP Server (Brave Search Integration)
  # ========================================
  brave-search-mcp:
    image: ghcr.io/bizoholic-digital/bizosaas-platform/brave-search-mcp:staging
    build:
      context: ./mcp-servers/brave-search
      dockerfile: Dockerfile
    container_name: brain-mcp-brave-search
    environment:
      - BRAVE_API_KEY=${BRAVE_API_KEY:-}
    networks:
      - brain-network
    stdin_open: true
    tty: true
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 256M
    healthcheck:
      test: [ "CMD", "python3", "-c", "import sys; sys.exit(0)" ]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  # ========================================
  # MCP Server (Filesystem Integration)
  # ========================================
  filesystem-mcp:
    image: ghcr.io/bizoholic-digital/bizosaas-platform/filesystem-mcp:staging
    build:
      context: ./mcp-servers/filesystem
      dockerfile: Dockerfile
    container_name: brain-mcp-filesystem
    environment:
      - FILESYSTEM_ROOT=/data
    volumes:
      - bizosaas-data:/data
    networks:
      - brain-network
    stdin_open: true
    tty: true
    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 128M
    healthcheck:
      test: [ "CMD", "python3", "-c", "import sys; sys.exit(0)" ]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  # ========================================
  # MCP Server (Google Drive Integration)
  # ========================================
  google-drive-mcp:
    image: ghcr.io/bizoholic-digital/bizosaas-platform/google-drive-mcp:staging
    build:
      context: ./mcp-servers/google-drive
      dockerfile: Dockerfile
    container_name: brain-mcp-google-drive
    environment:
      - GOOGLE_SERVICE_ACCOUNT_JSON=${GOOGLE_SERVICE_ACCOUNT_JSON:-}
    networks:
      - brain-network
    stdin_open: true
    tty: true
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 256M
    healthcheck:
      test: [ "CMD", "python3", "-c", "import sys; sys.exit(0)" ]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  # ========================================
  # MCP Server (GitHub Integration)
  # ========================================
  github-mcp:
    image: ghcr.io/bizoholic-digital/bizosaas-platform/github-mcp:staging
    build:
      context: ./mcp-servers/github
      dockerfile: Dockerfile
    container_name: brain-mcp-github
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
    networks:
      - brain-network
    stdin_open: true
    tty: true
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 256M
    healthcheck:
      test: [ "CMD", "python3", "-c", "import sys; sys.exit(0)" ]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  # ========================================
  # MCP Server (Slack Integration)
  # ========================================
  slack-mcp:
    image: ghcr.io/bizoholic-digital/bizosaas-platform/slack-mcp:staging
    build:
      context: ./mcp-servers/slack
      dockerfile: Dockerfile
    container_name: brain-mcp-slack
    environment:
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN:-}
    networks:
      - brain-network
    stdin_open: true
    tty: true
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 256M
    healthcheck:
      test: [ "CMD", "python3", "-c", "import sys; sys.exit(0)" ]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped
  # ═══════════════════════════════════════════════════════════════════════════
  # Networks
  # ═══════════════════════════════════════════════════════════════════════════
networks:
  brain-network:
    driver: bridge
    name: brain-network
  dokploy-network:
    external: true

volumes:
  bizosaas-data:
    name: bizosaas-data
