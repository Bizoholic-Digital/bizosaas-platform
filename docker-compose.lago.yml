services:
  lago-api:
    image: getlago/api:v1.17.0
    container_name: lago-api
    environment:
      # Cloud Database (Neon PostgreSQL)
      - DATABASE_URL=postgresql://neondb_owner:npg_puEbTnkSO9F8@ep-gentle-flower-a15rdh2r-pooler.ap-southeast-1.aws.neon.tech/neondb?sslmode=require
      - POSTGRES_URL=postgresql://neondb_owner:npg_puEbTnkSO9F8@ep-gentle-flower-a15rdh2r-pooler.ap-southeast-1.aws.neon.tech/neondb?sslmode=require
      - LAGO_DATABASE_URL=postgresql://neondb_owner:npg_puEbTnkSO9F8@ep-gentle-flower-a15rdh2r-pooler.ap-southeast-1.aws.neon.tech/neondb?sslmode=require

      # Cloud Cache (Redis Cloud)
      - REDIS_URL=redis://default:Gt7QxXA4ybMzYzD9e6KIBULfnv1IU6f9@redis-10690.c264.ap-south-1-1.ec2.cloud.redislabs.com:10690/1
      - LAGO_REDIS_URL=redis://default:Gt7QxXA4ybMzYzD9e6KIBULfnv1IU6f9@redis-10690.c264.ap-south-1-1.ec2.cloud.redislabs.com:10690/1

      # Lago Configuration
      - LAGO_API_URL=https://billing-api.bizoholic.net
      - LAGO_FRONT_URL=https://billing.bizoholic.net
      - SECRET_KEY_BASE=85acd00b662a82aa2132d7639de8e6de655dcfe2d568abd05fbd069de0092dd4
      - ENCRYPTION_PRIMARY_KEY=2f9700e1e19ffbf8f970fa260e356c2b606ac09f2ee71ecd2a630936209337fb
      - ENCRYPTION_DETERMINISTIC_KEY=92ae2adaeb2093deb1e41a61ccb9b6f4fe5ec94b6b373f74c976b6b199c4efa6
      - ENCRYPTION_KEY_DERIVATION_SALT=135f8017cd510bbea948b0b06109c2d479f6b3f3fcb3e4d4181bf478715b85ba

      # Email Configuration (optional)
      - LAGO_FROM_EMAIL=billing@bizoholic.net
      - LAGO_SMTP_ADDRESS=smtp.gmail.com
      - LAGO_SMTP_PORT=587

      # Rails Environment
      - RAILS_ENV=production
      - RAILS_LOG_TO_STDOUT=true
      - LAGO_RSA_PRIVATE_KEY=LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2QUlCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktZd2dnU2lBZ0VBQW9JQkFRQ2VBNHZIdU5ZK09wRXMKWGl6THJNQTNMM3ovYXozdktxbXUwN0lEcTFDcFhBZXFFTWh1eVRCSEs3QUsrNTRHaVNvcEowVXZzYmt2NFBVaAoyRDNNWXFYNnE0SDZScGVDYlRHRmNMMy8vZmZJYnpHMGtvanBka1NtU2FNUEFib3JBY0dCR05sK29SMUhHVmlBCldtbExmeitGM2RtSGRsZW16T1FsOHJ3OWdmbll5NmdJbGEwTGNNZWtqVk1UajF3Q2RPUml6OWRDQzUvZnBweXoKTzFaWTVlRDdDNkJibkVuQ01wTDBOb0JZZ05xUU93RkFUeklWL3RPRXVMeTlUL2xGRDhOd09PekU2YXFGb3VXWgpWRDNrV3ByM3NrVmtuekZ1d3ErQjJyL2pwNGx2ckNBV0hmMkJKQ3ZSTlhxZ2ozTlNYenptcFNubVVtSERyNXA1Ckw4TTFQdDBWQWdNQkFBRUNnZ0VBSVpraGJKc3B1dHViS0xMeGxYRXJBZER3SkNNNmJSTkdOeTArS2JlUWxDSkUKWXUza29HSFpDUmtKK3B2YjB3bnhWQVRNbWtLUTNOUlpheFBldUFtMXZ5SWVwZ2ZDaVhJTVdKSkxaQll0VElvUQpLSlFMMXBCV01vRnYwVzRObHIxdDFyUmc4cUx4WmIvRzZLdlF2Y1BWenZJSUlkeVE4SithVjFOUW9VZDB4NXJZCm1xQlhlU3BTUktVSDNuNjV5L1lVRmlQZlRDdXZJb3N3SldXcjl0MVNySUtFSmRnekNteUQ0TnB1US9CNXJIT28KaGNTYVZ4aFRmYWlxNWQyY1pBV3BzOHpvY2NaMWM4RHFnR25IM3E2ejl5a25pV3BzTHZMeHIyRWljR2tsREhZTwpQV1J1WFoxL1J4L2pkcTBwWnkvbG9aekRERnhXOTF0VmkvazVNeVlTRlFLQmdRRE1BSXVLV2ZaelFIekVTOFhmCmh1aEVyYnNHNUxOdHdPd3BpNWtnQ09PblNUQlhLY3d6Z1lueXhmcW0rNlZON1IvZ0VUVDBwcDNZdnYyVmtHcGUKODNnSllMbWFBbkF4a2tSaGpFeVFzVXJtZVFqNklQR0lMN3VDcHRWZGVMaDFBT1hRdmYxek5SVXBMV3ZuNUcwQwp2WnF6R2pHcE1wMVNSaTk5M20vSDJURVl2d0tCZ1FER1NqSFFxRXZPYVdlMy9zd2JvdXV4WlFWdDZlSVFpSnpsCmhaK0JSbGNibjk0dExCTWY5WnBZaTVidUs1ZGh0SmJOd04vSURNVDJVNjVSNE5BdGNNUnRzNzNIdTlOekVXcmIKUUlUTDJpZE14a21rUjZEK0U2SWtNbVdZeEh0YU5vb0EzNW5aTXlHMnhrUkgzTmVBd25OdkFSMFhmU3pMOXNmQwpyRG1ZUW5DTEt3S0JnRVpXNWNaRmNMR2FpYXFSU2QvaHYxSjI2S2JlMG5ORWN1bDhSY2NDNmFQem0yUmllQk5HClZnOU1iam1IU1I4T1pOQTRmcDdnbUVwMHlERDZ3NEtMeGxiTmNCR0hSN0gvOGU0RWx4M0kwNytWK2g5c25udEwKb2diUmlYNGFNdGU5QUlDeUVhTFlxYnd4K2lQUjRqaHdzZGVSYjVBY2NKdytzUDlnWkFCdmhmczNBb0dBUHpJdwpWRGIvQ2djUDlsVXZpZk5QdU5iZ2R4cGVZVFNaQkpHa3QxZkt0VlFyUkN4UzRCR3ZvbDdDdUorTi9LYklsVVRPClRYeThYV0ZvSWxKTEp1QlV5ajNKMDFscVY3Y0tYbHhldG5XTnB1dGZWd3M1SlNEdXdTaUt0cmlRTTcxRUdHa3IKS0UwaWhwVUQ5LzlMYzQ4RnFUQXFyR3pKbFN2T21KMjVNV3lqWDhjQ2dZQVBLOFVKREtRNUZXK3pCMkQyczVvRwpmT0hybXE3bkREeUhRZmk1dmJWOVlvRmtlNThPSnpnWllseUppUXJCOFYvT3hpTU9wd3VUYkc5eVZYQmFuRnY4ClpmNFNlUTRONWlkc0VlWU5ZSVZQQVJaWVE5ZGMwTmpTZ1N3Nk53ZVo1L2FEWDhvZUVuN2laSml0bW5CODM2YncKYU1NK1ZmcFZSQ1ZTamVFaFUzdWN6UT09Ci0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS0K
      - LAGO_RSA_PUBLIC_KEY=LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUFuZ09MeDdqV1BqcVJMRjRzeTZ6QQpOeTk4LzJzOTd5cXBydE95QTZ0UXFWd0hxaERJYnNrd1J5dXdDdnVlQm9rcUtTZEZMN0c1TCtEMUlkZzl6R0lsCitxdUIra2FYZ20weGhYQzkvLzMzeUc4eHRKS0k2WFpFcGttakR3RzZLd0hCZ1JqWmZxRWRSeGxZZ0ZwcFMzOC8KaGQzWmgzWlhwc3prSmZLOFBZSDUyTXVvQ0pXdEMzREhwSTFURTQ5Y0FuVGtZcy9YUWd1ZjM2YWNzenRXV09YZword3VnVzV4SndqS1M5RGFBV0lEYWtEc0JRRTh5RmY3VGhMaTh2VS81UlEvRGNEanN4T21xaGFMbG1WUTk1RnFhCjk3SkZaSjh4YnNLdmdkcS80NmVKYjZ3Z0ZoMzlnU1FyMFRWNm9JOXpVbDg4NXFVcDVsSmh3NithZVMvRE5UN2QKRlFJREFRQUIKLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tCg==
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=dokploy-network"
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  lago-front:
    image: getlago/front:v1.17.0
    container_name: lago-front
    environment:
      - LAGO_API_URL=https://billing-api.bizoholic.net
      - API_URL=https://billing-api.bizoholic.net
      - APP_ENV=production
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=dokploy-network"
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:80/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M

  lago-worker:
    image: getlago/api:v1.17.0
    container_name: lago-worker
    command: [ "./scripts/start.worker.sh" ]
    environment:
      # Cloud Database (Neon PostgreSQL)
      - DATABASE_URL=postgresql://neondb_owner:npg_puEbTnkSO9F8@ep-gentle-flower-a15rdh2r-pooler.ap-southeast-1.aws.neon.tech/neondb?sslmode=require
      - POSTGRES_URL=postgresql://neondb_owner:npg_puEbTnkSO9F8@ep-gentle-flower-a15rdh2r-pooler.ap-southeast-1.aws.neon.tech/neondb?sslmode=require
      - LAGO_DATABASE_URL=postgresql://neondb_owner:npg_puEbTnkSO9F8@ep-gentle-flower-a15rdh2r-pooler.ap-southeast-1.aws.neon.tech/neondb?sslmode=require

      # Cloud Cache (Redis Cloud)
      - REDIS_URL=redis://default:Gt7QxXA4ybMzYzD9e6KIBULfnv1IU6f9@redis-10690.c264.ap-south-1-1.ec2.cloud.redislabs.com:10690/1
      - LAGO_REDIS_URL=redis://default:Gt7QxXA4ybMzYzD9e6KIBULfnv1IU6f9@redis-10690.c264.ap-south-1-1.ec2.cloud.redislabs.com:10690/1

      # Lago Configuration
      - LAGO_API_URL=https://billing-api.bizoholic.net
      - SECRET_KEY_BASE=85acd00b662a82aa2132d7639de8e6de655dcfe2d568abd05fbd069de0092dd4
      - ENCRYPTION_PRIMARY_KEY=2f9700e1e19ffbf8f970fa260e356c2b606ac09f2ee71ecd2a630936209337fb
      - ENCRYPTION_DETERMINISTIC_KEY=92ae2adaeb2093deb1e41a61ccb9b6f4fe5ec94b6b373f74c976b6b199c4efa6
      - ENCRYPTION_KEY_DERIVATION_SALT=135f8017cd510bbea948b0b06109c2d479f6b3f3fcb3e4d4181bf478715b85ba

      # Rails Environment
      - RAILS_ENV=production
      - RAILS_LOG_TO_STDOUT=true
      - LAGO_RSA_PRIVATE_KEY=LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2QUlCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktZd2dnU2lBZ0VBQW9JQkFRQ2VBNHZIdU5ZK09wRXMKWGl6THJNQTNMM3ovYXozdktxbXUwN0lEcTFDcFhBZXFFTWh1eVRCSEs3QUsrNTRHaVNvcEowVXZzYmt2NFBVaAoyRDNNWXFYNnE0SDZScGVDYlRHRmNMMy8vZmZJYnpHMGtvanBka1NtU2FNUEFib3JBY0dCR05sK29SMUhHVmlBCldtbExmeitGM2RtSGRsZW16T1FsOHJ3OWdmbll5NmdJbGEwTGNNZWtqVk1UajF3Q2RPUml6OWRDQzUvZnBweXoKTzFaWTVlRDdDNkJibkVuQ01wTDBOb0JZZ05xUU93RkFUeklWL3RPRXVMeTlUL2xGRDhOd09PekU2YXFGb3VXWgpWRDNrV3ByM3NrVmtuekZ1d3ErQjJyL2pwNGx2ckNBV0hmMkJKQ3ZSTlhxZ2ozTlNYenptcFNubVVtSERyNXA1Ckw4TTFQdDBWQWdNQkFBRUNnZ0VBSVpraGJKc3B1dHViS0xMeGxYRXJBZER3SkNNNmJSTkdOeTArS2JlUWxDSkUKWXUza29HSFpDUmtKK3B2YjB3bnhWQVRNbWtLUTNOUlpheFBldUFtMXZ5SWVwZ2ZDaVhJTVdKSkxaQll0VElvUQpLSlFMMXBCV01vRnYwVzRObHIxdDFyUmc4cUx4WmIvRzZLdlF2Y1BWenZJSUlkeVE4SithVjFOUW9VZDB4NXJZCm1xQlhlU3BTUktVSDNuNjV5L1lVRmlQZlRDdXZJb3N3SldXcjl0MVNySUtFSmRnekNteUQ0TnB1US9CNXJIT28KaGNTYVZ4aFRmYWlxNWQyY1pBV3BzOHpvY2NaMWM4RHFnR25IM3E2ejl5a25pV3BzTHZMeHIyRWljR2tsREhZTwpQV1J1WFoxL1J4L2pkcTBwWnkvbG9aekRERnhXOTF0VmkvazVNeVlTRlFLQmdRRE1BSXVLV2ZaelFIekVTOFhmCmh1aEVyYnNHNUxOdHdPd3BpNWtnQ09PblNUQlhLY3d6Z1lueXhmcW0rNlZON1IvZ0VUVDBwcDNZdnYyVmtHcGUKODNnSllMbWFBbkF4a2tSaGpFeVFzVXJtZVFqNklQR0lMN3VDcHRWZGVMaDFBT1hRdmYxek5SVXBMV3ZuNUcwQwp2WnF6R2pHcE1wMVNSaTk5M20vSDJURVl2d0tCZ1FER1NqSFFxRXZPYVdlMy9zd2JvdXV4WlFWdDZlSVFpSnpsCmhaK0JSbGNibjk0dExCTWY5WnBZaTVidUs1ZGh0SmJOd04vSURNVDJVNjVSNE5BdGNNUnRzNzNIdTlOekVXcmIKUUlUTDJpZE14a21rUjZEK0U2SWtNbVdZeEh0YU5vb0EzNW5aTXlHMnhrUkgzTmVBd25OdkFSMFhmU3pMOXNmQwpyRG1ZUW5DTEt3S0JnRVpXNWNaRmNMR2FpYXFSU2QvaHYxSjI2S2JlMG5ORWN1bDhSY2NDNmFQem0yUmllQk5HClZnOU1iam1IU1I4T1pOQTRmcDdnbUVwMHlERDZ3NEtMeGxiTmNCR0hSN0gvOGU0RWx4M0kwNytWK2g5c25udEwKb2diUmlYNGFNdGU5QUlDeUVhTFlxYnd4K2lQUjRqaHdzZGVSYjVBY2NKdytzUDlnWkFCdmhmczNBb0dBUHpJdwpWRGIvQ2djUDlsVXZpZk5QdU5iZ2R4cGVZVFNaQkpHa3QxZkt0VlFyUkN4UzRCR3ZvbDdDdUorTi9LYklsVVRPClRYeThYV0ZvSWxKTEp1QlV5ajNKMDFscVY3Y0tYbHhldG5XTnB1dGZWd3M1SlNEdXdTaUt0cmlRTTcxRUdHa3IKS0UwaWhwVUQ5LzlMYzQ4RnFUQXFyR3pKbFN2T21KMjVNV3lqWDhjQ2dZQVBLOFVKREtRNUZXK3pCMkQyczVvRwpmT0hybXE3bkREeUhRZmk1dmJWOVlvRmtlNThPSnpnWllseUppUXJCOFYvT3hpTU9wd3VUYkc5eVZYQmFuRnY4ClpmNFNlUTRONWlkc0VlWU5ZSVZQQVJaWVE5ZGMwTmpTZ1N3Nk53ZVo1L2FEWDhvZUVuN2laSml0bW5CODM2YncKYU1NK1ZmcFZSQ1ZTamVFaFUzdWN6UT09Ci0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS0K
      - LAGO_RSA_PUBLIC_KEY=LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUFuZ09MeDdqV1BqcVJMRjRzeTZ6QQpOeTk4LzJzOTd5cXBydE95QTZ0UXFWd0hxaERJYnNrd1J5dXdDdnVlQm9rcUtTZEZMN0c1TCtEMUlkZzl6R0lsCitxdUIra2FYZ20weGhYQzkvLzMzeUc4eHRKS0k2WFpFcGttmjRkd1p6OFE0TFZKS0lRWFpFcGttajRkd1p6OFE0TFVpTGlYQUZnU3N2TzR6N2pXUGpxUkxGNHN5NnpBTnk5OC8yczk3eXFydE95QTZ0UXFWd0hxaERJYnNrd1J5dXdDdnVlQm9rcUtTZEZMN0c1TCtEMUlkZzl6R0lsCitxdUIra2FYZ20weGhYQzkvLzMzeUc4eHRKS0k2WFpFcGttakR3RzZLd0hCZ1JqWmZxRWRSeGxZZ0ZwcFMzOC8KaGQzWmgzWlhwc3prSmZLOFBZSDUyTXVvQ0pXdEMzREhwSTFURTQ5Y0FuVGtZcy9YUWd1ZjM2YWNzenRXV09YZword3VnVzV4SndqS1M5RGFBV0lEYWtEc0JRRTh5RmY3VGhMaTh2VS81UlEvRGNEanN4T21xaGFMbG1WUTk1RnFhCjk3SkZaSjh4YnNLdmdkcS80NmVKYjZ3Z0ZoMzlnU1FyMFRWNm9JOXpVbDg4NXFVcDVsSmh3NithZVMvRE5UN2QKRlFJREFRQUIKLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tCg==
    networks:
      - dokploy-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M

networks:
  dokploy-network:
    external: true
    name: dokploy-network
