services:
  lago-api:
    image: getlago/api:v1.17.0
    container_name: lago-api
    environment:
      # Cloud Database (Neon PostgreSQL)
      - DATABASE_URL=postgresql://neondb_owner:npg_puEbTnkSO9F8@ep-gentle-flower-a15rdh2r-pooler.ap-southeast-1.aws.neon.tech/neondb?sslmode=require
      - POSTGRES_URL=postgresql://neondb_owner:npg_puEbTnkSO9F8@ep-gentle-flower-a15rdh2r-pooler.ap-southeast-1.aws.neon.tech/neondb?sslmode=require

      # Cloud Cache (Redis Cloud)
      - REDIS_URL=redis://default:Gt7QxXA4ybMzYzD9e6KIBULfnv1IU6f9@redis-10690.c264.ap-south-1-1.ec2.cloud.redislabs.com:10690/1

      # Lago Configuration
      - LAGO_API_URL=https://billing-api.bizoholic.net
      - LAGO_FRONT_URL=https://billing.bizoholic.net
      - SECRET_KEY_BASE=your-secret-key-base-change-this-in-production
      - ENCRYPTION_PRIMARY_KEY=your-encryption-primary-key-change-this
      - ENCRYPTION_DETERMINISTIC_KEY=your-encryption-deterministic-key
      - ENCRYPTION_KEY_DERIVATION_SALT=your-encryption-key-derivation-salt

      # Email Configuration (optional)
      - LAGO_FROM_EMAIL=billing@bizoholic.net
      - LAGO_SMTP_ADDRESS=smtp.gmail.com
      - LAGO_SMTP_PORT=587

      # Rails Environment
      - RAILS_ENV=production
      - RAILS_LOG_TO_STDOUT=true
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=dokploy-network"
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  lago-front:
    image: getlago/front:v1.17.0
    container_name: lago-front
    environment:
      - LAGO_API_URL=https://billing-api.bizoholic.net
      - API_URL=https://billing-api.bizoholic.net
      - APP_ENV=production
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=dokploy-network"
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:80/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M

  lago-worker:
    image: getlago/api:v1.17.0
    container_name: lago-worker
    command: [ "./scripts/start.worker.sh" ]
    environment:
      # Cloud Database (Neon PostgreSQL)
      - DATABASE_URL=postgresql://neondb_owner:npg_puEbTnkSO9F8@ep-gentle-flower-a15rdh2r-pooler.ap-southeast-1.aws.neon.tech/neondb?sslmode=require
      - POSTGRES_URL=postgresql://neondb_owner:npg_puEbTnkSO9F8@ep-gentle-flower-a15rdh2r-pooler.ap-southeast-1.aws.neon.tech/neondb?sslmode=require

      # Cloud Cache (Redis Cloud)
      - REDIS_URL=redis://default:Gt7QxXA4ybMzYzD9e6KIBULfnv1IU6f9@redis-10690.c264.ap-south-1-1.ec2.cloud.redislabs.com:10690/1

      # Lago Configuration
      - LAGO_API_URL=https://billing-api.bizoholic.net
      - SECRET_KEY_BASE=your-secret-key-base-change-this-in-production
      - ENCRYPTION_PRIMARY_KEY=your-encryption-primary-key-change-this
      - ENCRYPTION_DETERMINISTIC_KEY=your-encryption-deterministic-key
      - ENCRYPTION_KEY_DERIVATION_SALT=your-encryption-key-derivation-salt

      # Rails Environment
      - RAILS_ENV=production
      - RAILS_LOG_TO_STDOUT=true
    networks:
      - dokploy-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M

networks:
  dokploy-network:
    external: true
    name: dokploy-network
