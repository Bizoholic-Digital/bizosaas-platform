# Frontend Services Fix Implementation Plan

## üéØ Objective
Fix all frontend services to work correctly with path-based routing and implement unified SSO authentication across all platforms.

## üìä Current State Analysis

### Services & Routing:
1. **Client Portal** - `stg.bizoholic.com/portal` ‚Üí Port 3003
2. **Admin Dashboard** - `stg.bizoholic.com/admin` ‚Üí Port 3000  
3. **Bizoholic Frontend** - `stg.bizoholic.com` ‚Üí Port 3001 (ROOT)
4. **Business Directory** - `stg.bizoholic.com/directory` ‚Üí Port 3004
5. **Coreldove Frontend** - `stg.coreldove.com` ‚Üí Port 3002 (ROOT)
6. **Thrillring Gaming** - `stg.thrillring.com` ‚Üí Port 3006 (ROOT)

### Current Issues:
- ‚úÖ Dokploy - Working
- ‚ùå Client Portal - 404 (no basePath configured)
- ‚ùå Admin Dashboard - 404 (no basePath configured)  
- ‚ùå Business Directory - Likely 404 (no basePath configured)
- ‚ö†Ô∏è Bizoholic Frontend - Working but login redirect needs verification
- ‚ö†Ô∏è Coreldove Frontend - Needs verification
- ‚ö†Ô∏è Thrillring Gaming - Needs verification

## üîß Solution Strategy

### Phase 1: Fix Path-Based Routing (Client Portal, Admin, Directory)
**Problem**: Apps served at `/portal`, `/admin`, `/directory` but Next.js serves from `/`

**Solution**: Add `basePath` to `next.config.js`:
```javascript
module.exports = {
  basePath: '/portal', // or '/admin', '/directory'
  // ... rest of config
}
```

### Phase 2: Unified Authentication System
**Components**:
1. **Auth Service** (Port 8007) - Central authentication
2. **Brain Gateway** (Port 8001) - API proxy with auth
3. **Frontend Auth Client** - Shared across all apps

**Authentication Flow**:
```
User ‚Üí Frontend ‚Üí Brain Gateway (/api/auth/*) ‚Üí Auth Service
                ‚Üì
          JWT Token stored in cookie
                ‚Üì
          Protected routes check token
```

### Phase 3: SSO Implementation
**Shared Components**:
- Auth context provider
- Protected route wrapper
- Login/logout handlers
- Token refresh logic

## üìã Implementation Order

### Step 1: Fix Client Portal (PRIORITY 1)
**Files to modify**:
- `apps/client-portal/next.config.js` - Add `basePath: '/portal'`
- Verify auth integration with Brain Gateway
- Test login ‚Üí dashboard redirect

**Expected URLs**:
- Login: `stg.bizoholic.com/portal/login`
- Dashboard: `stg.bizoholic.com/portal/dashboard`

### Step 2: Fix Admin Dashboard (PRIORITY 2)
**Files to modify**:
- `apps/bizosaas-admin/next.config.js` - Add `basePath: '/admin'`
- Verify auth integration
- Test login ‚Üí dashboard redirect

**Expected URLs**:
- Login: `stg.bizoholic.com/admin/login`
- Dashboard: `stg.bizoholic.com/admin/dashboard`

### Step 3: Fix Business Directory (PRIORITY 3)
**Files to modify**:
- `apps/business-directory/next.config.js` - Add `basePath: '/directory'`
- Verify auth integration

### Step 4: Verify Root Domain Apps (PRIORITY 4)
**Apps**: Bizoholic, Coreldove, Thrillring
- These should NOT have basePath (they're at root)
- Verify Wagtail login at `stg.bizoholic.com/login` still works
- Ensure no conflicts with path-based routes

### Step 5: Implement Unified SSO (PRIORITY 5)
**Create shared auth package**:
- `packages/shared-auth/` with:
  - AuthProvider component
  - useAuth hook
  - ProtectedRoute component
  - Auth API client

**Integration points**:
- All apps import from shared package
- Single source of truth for auth logic
- Consistent user experience

## üîê Authentication Architecture

### Shared Auth Configuration:
```typescript
// Environment variables (same across all apps)
NEXT_PUBLIC_AUTH_API_URL=http://72.60.219.244:8001/api/auth
NEXT_PUBLIC_BRAIN_API_URL=http://72.60.219.244:8001
JWT_SECRET=<shared-secret>
NEXTAUTH_SECRET=<shared-secret>
```

### Auth Flow:
1. User visits protected route
2. Check for valid JWT token
3. If no token ‚Üí redirect to `/login` (with basePath)
4. Login form submits to Brain Gateway
5. Brain Gateway proxies to Auth Service
6. Auth Service validates credentials
7. Return JWT token
8. Store in httpOnly cookie
9. Redirect to dashboard

## üìù Testing Checklist

### For Each App:
- [ ] Login page accessible
- [ ] Login redirects to dashboard
- [ ] Protected routes require auth
- [ ] Public routes accessible without auth
- [ ] Logout works correctly
- [ ] Token refresh works
- [ ] Cross-app SSO works (login once, access all)

### Specific Tests:
- [ ] Client Portal: `/portal/login` ‚Üí `/portal/dashboard`
- [ ] Admin Dashboard: `/admin/login` ‚Üí `/admin/dashboard`
- [ ] Bizoholic: `/login` ‚Üí Wagtail admin (don't break!)
- [ ] Coreldove: Root domain works
- [ ] Thrillring: Root domain works
- [ ] Business Directory: `/directory` works

## üöÄ Deployment Strategy

### For Each App:
1. Update `next.config.js` locally
2. Build Docker image
3. Push to GHCR
4. Update Dokploy deployment
5. Test thoroughly
6. Move to next app

### Rollback Plan:
- Keep previous Docker images tagged
- Can quickly revert via Dokploy if issues arise

## ‚ö†Ô∏è Risk Mitigation

### Don't Break:
1. **Wagtail Login** (`stg.bizoholic.com/login`) - This is separate from Next.js auth
2. **Root domain apps** - Bizoholic, Coreldove, Thrillring should continue working
3. **API routes** - Brain Gateway routing must remain intact

### Validation:
- Test each app before moving to next
- Keep Dokploy accessible for quick fixes
- Monitor logs during deployment

## üì¶ Deliverables

1. ‚úÖ All frontend apps accessible and working
2. ‚úÖ Unified authentication across all platforms
3. ‚úÖ SSO implementation (login once, access all)
4. ‚úÖ No broken existing functionality
5. ‚úÖ Documentation of auth flow
6. ‚úÖ Updated Docker images in GHCR

## üé¨ Next Actions

**IMMEDIATE**: Start with Client Portal
1. View current `next.config.js`
2. Add `basePath: '/portal'`
3. Update asset prefix if needed
4. Rebuild Docker image
5. Test deployment
6. Verify login flow

**Then**: Proceed to Admin Dashboard with same approach
