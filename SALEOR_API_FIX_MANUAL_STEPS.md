# Saleor Dashboard Login Fix - Manual Implementation Guide

**Issue:** Dashboard login fails with "Login went wrong" error
**Root Cause:** API_URL points to internal Docker IP (10.0.1.47:8000) - not accessible from browser
**Solution:** Expose Saleor API via public domain and update dashboard configuration

**Status:** ⚠️ REQUIRES MANUAL DOKPLOY UI CONFIGURATION

---

## Current Configuration Analysis

### Saleor API Container Status
```
Container: backend-saleor-api.1.2b4cetxidpwq0i5l3nbgmi10p
Internal IP: 10.0.1.47:8000
Traefik Labels: NONE (Not publicly exposed)
Status: Running
```

### Dashboard Current Configuration
```
Container: frontendservices-saleordashboard-84ku62
URL: https://stg.coreldove.com/dashboard/
API_URL: http://10.0.1.47:8000/graphql/ ❌ (WRONG - Internal IP)
Status: Running but login broken
```

### Problem
```
User Browser → https://stg.coreldove.com/dashboard/ (loads ✅)
    ↓
Browser JavaScript tries to connect to:
http://10.0.1.47:8000/graphql/ ❌ (TIMEOUT - unreachable)
```

---

## STEP-BY-STEP FIX IMPLEMENTATION

### Step 1: Configure Traefik Routing for Saleor API (5 minutes)

**Action:** Expose Saleor API via `api.coreldove.com`

**Dokploy UI Steps:**

1. Open Dokploy dashboard: https://automationhub-n8n-91feb0-194-238-16-237.traefik.me
2. Login with credentials from `/home/alagiri/projects/bizoholic/credentials.md`
3. Navigate to: **Backend Services** project (or wherever saleor-api is located)
4. Find service: **saleor-api** (or similar name)
5. Click to open service configuration
6. Go to: **Routing → Domain** tab
7. Click: **"Add Domain"** button

**Domain Configuration:**
```yaml
Host: api.coreldove.com
Path: /
Container Port: 8000
HTTPS: ✅ Enabled
Certificate Resolver: letsencrypt
```

8. Click **"Save"**
9. Click **"Deploy"** or **"Restart"** button (top right)
10. Wait 30-60 seconds for Traefik to apply changes

**Expected Traefik Labels (auto-generated by Dokploy):**
```yaml
traefik.enable=true
traefik.http.routers.saleor-api.rule=Host(`api.coreldove.com`)
traefik.http.routers.saleor-api.entrypoints=websecure
traefik.http.routers.saleor-api.tls=true
traefik.http.routers.saleor-api.tls.certresolver=letsencrypt
traefik.http.services.saleor-api.loadbalancer.server.port=8000
```

**Verification:**
```bash
# Test API is now accessible (run from local machine after DNS propagation)
curl -I https://api.coreldove.com/graphql/

# Expected: HTTP/2 200 (or similar successful response)
```

---

### Step 2: Update DNS Record (2 minutes)

**Action:** Point `api.coreldove.com` to KVM4 server

**DNS Configuration Required:**
```
Type: A Record
Name: api
Domain: coreldove.com
Value: 72.60.219.244
TTL: 3600 (or Auto)
```

**Where to Update:**
- Login to your DNS provider (Cloudflare, Hostinger, etc.)
- Add the A record as shown above
- Wait 1-5 minutes for DNS propagation

**Verification:**
```bash
# Check DNS resolution
nslookup api.coreldove.com

# Expected output should include:
# Address: 72.60.219.244
```

---

### Step 3: Update Saleor Core CORS Configuration (3 minutes)

**Action:** Allow dashboard domain to access API

**Dokploy UI Steps:**

1. In Dokploy, navigate to: **Backend Services** → **saleor-api**
2. Go to: **Environment** tab
3. Find or add environment variable: `ALLOWED_CLIENT_HOSTS`
4. Update/Add value:
   ```
   ALLOWED_CLIENT_HOSTS=stg.coreldove.com,api.coreldove.com
   ```
5. Click **"Save"**
6. Click **"Restart"** button to apply changes

**Alternative via SSH (if Dokploy UI is not working):**
```bash
ssh root@72.60.219.244

# Check current environment variables
docker inspect backend-saleor-api.1.2b4cetxidpwq0i5l3nbgmi10p | grep ALLOWED_CLIENT_HOSTS

# Note: You'll need to update via Dokploy UI to persist changes
# Container restarts will lose manual docker exec changes
```

**Why This Is Needed:**
- Prevents CORS errors in browser console
- Allows dashboard (stg.coreldove.com) to make API calls to api.coreldove.com

---

### Step 4: Update Saleor Dashboard API_URL (3 minutes)

**Action:** Change API URL from internal IP to public domain

**Dokploy UI Steps:**

1. In Dokploy, navigate to: **Frontend Services** → **saleor-dashboard**
2. Go to: **Environment** tab
3. Find environment variable: `API_URL`
4. **Change from:**
   ```
   API_URL=http://10.0.1.47:8000/graphql/
   ```
5. **Change to:**
   ```
   API_URL=https://api.coreldove.com/graphql/
   ```
6. Click **"Save"**
7. Click **"Restart"** button
8. Wait 30-60 seconds for container to restart

**Verification:**
```bash
# SSH to KVM4
ssh root@72.60.219.244

# Check new environment variable
docker inspect frontendservices-saleordashboard-84ku62 | grep API_URL

# Expected output:
# "API_URL=https://api.coreldove.com/graphql/"
```

---

### Step 5: Create Saleor Superuser (2 minutes)

**Action:** Create admin account for dashboard login

**Run via SSH:**
```bash
# SSH to KVM4
ssh root@72.60.219.244

# Create superuser
docker exec backend-saleor-api.1.2b4cetxidpwq0i5l3nbgmi10p \
  python manage.py createsuperuser \
  --email admin@coreldove.com \
  --no-input 2>&1 || echo "User may already exist"

# Set password
docker exec backend-saleor-api.1.2b4cetxidpwq0i5l3nbgmi10p \
  python manage.py shell -c "
from saleor.account.models import User
try:
    u = User.objects.get(email='admin@coreldove.com')
    u.set_password('CoreLdove2025!Admin')
    u.is_staff = True
    u.is_superuser = True
    u.is_active = True
    u.save()
    print('✅ Superuser created/updated successfully')
except Exception as e:
    print(f'❌ Error: {e}')
"
```

**Expected Output:**
```
✅ Superuser created/updated successfully
```

**Login Credentials:**
```
Email: admin@coreldove.com
Password: CoreLdove2025!Admin
```

---

### Step 6: Clear Browser Cache and Test (2 minutes)

**Action:** Verify dashboard login works

**Testing Steps:**

1. **Clear Browser Cache:**
   - Press: `Ctrl+Shift+Delete` (Chrome/Firefox)
   - Select: "Cached images and files"
   - Click: "Clear data"

2. **Open Dashboard:**
   ```
   URL: https://stg.coreldove.com/dashboard/
   ```

3. **Login:**
   ```
   Email: admin@coreldove.com
   Password: CoreLdove2025!Admin
   ```

4. **Expected Result:**
   - ✅ Dashboard loads
   - ✅ Login succeeds
   - ✅ Store data displays
   - ✅ No errors in browser console

5. **Check Browser Console (F12):**
   - Open: Developer Tools (F12)
   - Go to: Console tab
   - Look for: No CORS errors
   - Network tab should show: Successful GraphQL requests to `https://api.coreldove.com/graphql/`

---

## VERIFICATION CHECKLIST

### Backend API Exposure
- [ ] Traefik labels added to Saleor API container
- [ ] DNS record for `api.coreldove.com` points to 72.60.219.244
- [ ] HTTPS certificate obtained (Let's Encrypt)
- [ ] API accessible via: `https://api.coreldove.com/graphql/`

**Test Command:**
```bash
curl -I https://api.coreldove.com/graphql/
# Expected: HTTP/2 200 or similar success
```

### CORS Configuration
- [ ] `ALLOWED_CLIENT_HOSTS` includes: `stg.coreldove.com,api.coreldove.com`
- [ ] Saleor API container restarted after environment change
- [ ] No CORS errors in browser console

**Verification:**
```bash
ssh root@72.60.219.244
docker inspect backend-saleor-api.1.2b4cetxidpwq0i5l3nbgmi10p | grep ALLOWED_CLIENT_HOSTS
```

### Dashboard Configuration
- [ ] `API_URL` changed to: `https://api.coreldove.com/graphql/`
- [ ] Dashboard container restarted
- [ ] Dashboard still accessible at: `https://stg.coreldove.com/dashboard/`

**Verification:**
```bash
ssh root@72.60.219.244
docker inspect frontendservices-saleordashboard-84ku62 | grep API_URL
```

### User Authentication
- [ ] Superuser created: `admin@coreldove.com`
- [ ] Password set to: `CoreLdove2025!Admin`
- [ ] User has staff and superuser permissions
- [ ] User is active

**Test Login:**
- Navigate to: https://stg.coreldove.com/dashboard/
- Login with admin credentials
- Verify successful login

### Browser Testing
- [ ] Browser cache cleared
- [ ] Dashboard login page loads
- [ ] Login succeeds with admin credentials
- [ ] Store data displays after login
- [ ] No JavaScript errors in console
- [ ] Network tab shows successful API calls

---

## TROUBLESHOOTING

### Issue 1: DNS Not Resolving
**Symptoms:** `api.coreldove.com` not resolving to 72.60.219.244

**Fix:**
```bash
# Test DNS
nslookup api.coreldove.com

# Temporary workaround: Add to /etc/hosts for testing
echo "72.60.219.244 api.coreldove.com" | sudo tee -a /etc/hosts

# Test API
curl -I https://api.coreldove.com/graphql/
```

### Issue 2: SSL Certificate Not Obtained
**Symptoms:** `curl` shows SSL certificate error

**Diagnosis:**
```bash
# Check Traefik logs
ssh root@72.60.219.244
docker logs traefik 2>&1 | grep -i "api.coreldove.com" | tail -50
```

**Common Causes:**
- DNS not propagated yet (wait 5-10 minutes)
- Port 443 not accessible
- Let's Encrypt rate limit hit (unlikely)

### Issue 3: CORS Errors in Browser
**Symptoms:** Browser console shows:
```
Access to fetch at 'https://api.coreldove.com/graphql/' blocked by CORS
```

**Fix:**
```bash
# Verify ALLOWED_CLIENT_HOSTS includes dashboard domain
ssh root@72.60.219.244
docker inspect backend-saleor-api.1.2b4cetxidpwq0i5l3nbgmi10p | grep ALLOWED_CLIENT_HOSTS

# Should include: stg.coreldove.com,api.coreldove.com
# If not, update via Dokploy UI and restart container
```

### Issue 4: Login Still Fails
**Symptoms:** "Login went wrong" error persists

**Diagnosis Steps:**

1. **Check API Accessibility:**
   ```bash
   curl -I https://api.coreldove.com/graphql/
   # Must return HTTP 200
   ```

2. **Check Dashboard API_URL:**
   ```bash
   ssh root@72.60.219.244
   docker inspect frontendservices-saleordashboard-84ku62 | grep API_URL
   # Must show: https://api.coreldove.com/graphql/
   ```

3. **Check Browser Network Tab:**
   - Open: F12 → Network tab
   - Try login
   - Look for: GraphQL request to `api.coreldove.com`
   - Check: Request status (should be 200 or 400, NOT timeout)

4. **Check Superuser Exists:**
   ```bash
   ssh root@72.60.219.244
   docker exec backend-saleor-api.1.2b4cetxidpwq0i5l3nbgmi10p \
     python manage.py shell -c "from saleor.account.models import User; print(User.objects.filter(email='admin@coreldove.com').first())"
   ```

---

## POST-FIX: Architecture Flow

### New Architecture (FIXED)
```
User Browser
    ↓
https://stg.coreldove.com/dashboard/ (Dashboard loads ✅)
    ↓
Browser JavaScript calls:
https://api.coreldove.com/graphql/ (Public domain ✅)
    ↓
Traefik (Reverse Proxy)
    ↓
Saleor API Container (10.0.1.47:8000) ✅
    ↓
PostgreSQL Database ✅
```

### Key Changes
1. **API Exposure:** Saleor API now accessible via `api.coreldove.com`
2. **Dashboard Config:** API_URL updated to use public domain
3. **CORS:** Dashboard domain whitelisted in Saleor Core
4. **SSL:** Let's Encrypt certificate for `api.coreldove.com`

---

## NEXT STEPS AFTER FIX

Once login is working:

1. **Test Dashboard Functionality:**
   - Create test product
   - Create test order
   - Verify all features work

2. **Implement Webhook Integration (Optional):**
   - See: `SALEOR_WEBHOOK_CREWAI_INTEGRATION_PLAN.md`
   - Configure webhooks in dashboard
   - Implement Brain Gateway webhook endpoints
   - Activate CrewAI automation

3. **Update Credentials Documentation:**
   - Update API URL in credentials.md
   - Document new architecture

4. **Proceed to Next Frontend:**
   - Recommended: CoreLdove Setup Wizard (1-2 days)
   - Alternative: Analytics Dashboard (2-3 days)

---

## IMPLEMENTATION SUMMARY

**Total Time Estimate:** 15-20 minutes

**Steps:**
1. Configure Traefik routing (5 min) - **MANUAL DOKPLOY UI**
2. Update DNS (2 min) - **MANUAL DNS PROVIDER**
3. Update CORS (3 min) - **MANUAL DOKPLOY UI**
4. Update Dashboard API_URL (3 min) - **MANUAL DOKPLOY UI**
5. Create superuser (2 min) - **AUTOMATED VIA SSH**
6. Test login (2 min) - **MANUAL BROWSER TEST**

**Required Access:**
- Dokploy UI access
- DNS provider access
- SSH access to KVM4 (for superuser creation)

**Files to Reference:**
- [SALEOR_DASHBOARD_LOGIN_FIX.md](SALEOR_DASHBOARD_LOGIN_FIX.md) - Detailed troubleshooting
- [fix-saleor-dashboard-api.sh](fix-saleor-dashboard-api.sh) - Automated script (partial)
- [/home/alagiri/projects/bizoholic/credentials.md](/home/alagiri/projects/bizoholic/credentials.md) - Dokploy credentials

---

**Status:** ⚠️ **AWAITING MANUAL IMPLEMENTATION**
**Next Action:** Follow Steps 1-6 above in Dokploy UI
**Expected Result:** Dashboard login works with admin@coreldove.com / CoreLdove2025!Admin
**Date Created:** November 3, 2025
